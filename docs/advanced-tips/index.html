<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.12.2 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Taking Chaos Monkey to the Next Level - Advanced Developer Guide - Gremlin: Chaos Monkey</title>
<meta name="description" content="A detailed, advanced developer guide for Chaos Monkey and related alternatives/technologies.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Gremlin: Chaos Monkey">
<meta property="og:title" content="Taking Chaos Monkey to the Next Level - Advanced Developer Guide">
<meta property="og:url" content="http://localhost:4000/gremlin-chaos-monkey/advanced-tips/">








  <meta property="article:published_time" content="2018-08-30T00:00:00-07:00">





  

  


<link rel="canonical" href="http://localhost:4000/gremlin-chaos-monkey/advanced-tips/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Gabe Wyatt",
      "url": "http://localhost:4000/gremlin-chaos-monkey",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/gremlin-chaos-monkey/feed.xml" type="application/atom+xml" rel="alternate" title="Gremlin: Chaos Monkey Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/gremlin-chaos-monkey/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->
<link rel="icon" href="/favicon.ico" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/gremlin-chaos-monkey/">Gremlin: Chaos Monkey</a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="http://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="http://localhost:4000/gremlin-chaos-monkey/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Taking Chaos Monkey to the Next Level - Advanced Developer Guide</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Hub Pages</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/" class="">Chaos Monkey Guide for Engineers</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/origin-netflix" class="">The Origin of Chaos Monkey</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/developer-tutorial" class="">Chaos Monkey Tutorial</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/advanced-tips" class="">Advanced Developer Guide</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/simian-army" class="">The Simian Army</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/downloads-resources" class="">Chaos Monkey Resources</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives" class="">Chaos Monkey Alternatives</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Taking Chaos Monkey to the Next Level - Advanced Developer Guide">
    
    <meta itemprop="datePublished" content="August 30, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Taking Chaos Monkey to the Next Level - Advanced Developer Guide
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  21 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> </h4></header>
              <ul class="toc__menu">
  <li><a href="#how-to-deploy-spinnaker-on-aws-with-kubernetes">How to Deploy Spinnaker on AWS with Kubernetes</a>
    <ul>
      <li><a href="#install-halyard">Install Halyard</a></li>
      <li><a href="#install-aws-cli">Install AWS CLI</a></li>
      <li><a href="#setup-the-cloudformation-spinnaker-stack">Setup the CloudFormation Spinnaker Stack</a></li>
      <li><a href="#install-kubectl">Install Kubectl</a></li>
      <li><a href="#install-aws-iam-authenticator">Install AWS IAM Authenticator</a></li>
      <li><a href="#configure-kubectl">Configure Kubectl</a></li>
      <li><a href="#create-aws-accounts-and-roles">Create AWS Accounts and Roles</a></li>
      <li><a href="#add-kubernetes-provider-to-halyard">Add Kubernetes Provider to Halyard</a></li>
      <li><a href="#add-aws-provider-to-halyard">Add AWS Provider to Halyard</a></li>
      <li><a href="#add-ecs-provider-to-halyard">Add ECS Provider to Halyard</a></li>
      <li><a href="#use-distributed-deployment">Use Distributed Deployment</a></li>
      <li><a href="#use-s3-for-persistent-storage">Use S3 for Persistent Storage</a></li>
      <li><a href="#create-kubernetes-worker-nodes">Create Kubernetes Worker Nodes</a></li>
      <li><a href="#deploy-spinnaker">Deploy Spinnaker</a></li>
    </ul>
  </li>
  <li><a href="#using-chaos-monkey-on-kubernetes">Using Chaos Monkey on Kubernetes</a>
    <ul>
      <li><a href="#install-mysql">Install MySQL</a></li>
      <li><a href="#setup-mysql-for-chaos-monkey">Setup MySQL for Chaos Monkey</a></li>
      <li><a href="#install-chaos-monkey">Install Chaos Monkey</a></li>
      <li><a href="#configure-chaos-monkey-on-spinnaker">Configure Chaos Monkey on Spinnaker</a></li>
    </ul>
  </li>
  <li><a href="#how-to-deploy-chaos-monkey">How to Deploy Chaos Monkey</a></li>
  <li><a href="#using-chaos-monkey">Using Chaos Monkey</a>
    <ul>
      <li><a href="#scheduling-chaos-monkey-terminations">Scheduling Chaos Monkey Terminations</a></li>
    </ul>
  </li>
</ul>
            </nav>
          </aside>
        
        <h2 id="how-to-deploy-spinnaker-on-aws-with-kubernetes">How to Deploy Spinnaker on AWS with Kubernetes</h2>

<h3 id="install-halyard">Install Halyard</h3>

<ol>
  <li>Download Halyard installation script.
    <ul>
      <li>For Debian/Ubuntu: <code class="highlighter-rouge">$ curl -O https://raw.githubusercontent.com/spinnaker/halyard/master/install/debian/InstallHalyard.sh</code></li>
      <li>For MacOS: <code class="highlighter-rouge">$ curl -O https://raw.githubusercontent.com/spinnaker/halyard/master/install/macos/InstallHalyard.sh</code></li>
    </ul>
  </li>
  <li>Install Halyard: <code class="highlighter-rouge">$ sudo bash InstallHalyard.sh</code>
    <ul>
      <li>If prompted, default values are typically OK.</li>
    </ul>
  </li>
  <li>Source your <code class="highlighter-rouge">.bashrc</code> file by inputting: <code class="highlighter-rouge">$ . ~/.bashrc</code>.</li>
  <li>
    <p>Verify Halyard was installed by checking the version.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> hal <span class="nt">-v</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="install-aws-cli">Install AWS CLI</h3>

<p>Install the <a href="https://docs.aws.amazon.com/cli/latest/userguide/installing.html">AWS CLI tool</a> on your machine, if you haven’t done so already.</p>

<div class="premonition info modified"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Simplifying AWS Credentials</p><p>You can make future AWS CLI commands easier by adding creating AWS <code class="highlighter-rouge">profiles</code>, which will add configuration and credentials to the local <code class="highlighter-rouge">~/.aws/credentials</code> file.  &gt; We’ll just be using a single (<code class="highlighter-rouge">default</code>) profile here, so we don’t need to specify an actual profile name, but we could do so with the <code class="highlighter-rouge">--profile &lt;profile-name&gt;</code> flag as part of the <code class="highlighter-rouge">aws configure</code> command.  Check out the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html">official documentation</a> for more info.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws configure
AWS Access Key ID <span class="o">[</span>None]: &lt;AWS_ACCESS_KEY_ID&gt;
AWS Secret Access Key <span class="o">[</span>None]: &lt;AWS_SECRET_ACCESS_KEY&gt;
Default region name <span class="o">[</span>None]: us-west-2
Default output format <span class="o">[</span>None]: text
</code></pre></div></div>
<p>In the future, simply add the <code class="highlighter-rouge">--profile &lt;profile-name&gt;</code> flag to any AWS CLI command to force AWS CLI to use a specific profile/account.</p></div></div>

<h3 id="setup-the-cloudformation-spinnaker-stack">Setup the CloudFormation Spinnaker Stack</h3>

<p>Now that the AWS CLI is on your machine you’re ready to start the heavy lifting by deploying the EKS cluster via AWS CloudFormation.  This process takes a while for everything to propagate, so get it started while you work on the next few steps.</p>

<ol>
  <li>
    <p>Download <a href="https://d3079gxvs8ayeg.cloudfront.net/templates/managing.yaml">this</a> <code class="highlighter-rouge">managing.yaml</code> template.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://d3079gxvs8ayeg.cloudfront.net/templates/managing.yaml
</code></pre></div>    </div>

    <div class="premonition info modified"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Stack Configuration</p><p>If you need to configure the stack to your own particular needs you can easily edit the template YAML as necessary.  For example, in this guide we’re only using a single <strong>managing</strong> account to handle Spinnaker/Kubernetes in AWS, but if you need to also include additional <strong>managed</strong> accounts you’ll want to add their respective AWS ARN strings to the <code class="highlighter-rouge">managing.yaml</code> file <a href="https://gist.github.com/GabeStah/524fdb512e65e354076d71e53d9994eb#file-managing-yaml-L158">around this line</a>.</p></div></div>
  </li>
  <li>
    <p>Now we’ll use AWS CLI to issue a <code class="highlighter-rouge">cloudformation deploy</code> command to create a new <code class="highlighter-rouge">spinnaker-managing-infrastructure-setup</code> stack using the <code class="highlighter-rouge">managing.yaml</code> template.  From here on out this guide will use explicit names where applicable, but feel free to customize options as you see fit (such as the <strong>stack name</strong>, <strong>EksClusterName</strong>, and so forth).</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> aws cloudformation deploy <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--template-file</span> managing.yaml <span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM <span class="se">\</span>
 <span class="nt">--parameter-overrides</span> <span class="nv">UseAccessKeyForAuthentication</span><span class="o">=</span><span class="nb">false </span><span class="nv">EksClusterName</span><span class="o">=</span>spinnaker-cluster
</code></pre></div>    </div>
  </li>
  <li>
    <p>This process will take 10 - 15 minutes to complete issue the following commands, which will use the AWS CLI to assign some environment variables values from the <code class="highlighter-rouge">spinnaker-managing-infrastructure-setup</code> stack we just created.  We’ll be using these values throughout the remainder of this guide.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">VPC_ID</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`VpcId`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">CONTROL_PLANE_SG</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`SecurityGroups`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">AUTH_ARN</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`AuthArn`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">SUBNETS</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`SubnetIds`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">MANAGING_ACCOUNT_ID</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`ManagingAccountId`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">EKS_CLUSTER_ENDPOINT</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`EksClusterEndpoint`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">EKS_CLUSTER_NAME</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`EksClusterName`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">EKS_CLUSTER_CA_DATA</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`EksClusterCA`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">SPINNAKER_INSTANCE_PROFILE_ARN</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`SpinnakerInstanceProfileArn`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
</code></pre></div>    </div>

    <div class="premonition info modified"><div class="fa fa-info-circle"></div><div class="content"><p>You can easily output the value of an exported variable with <code class="highlighter-rouge">echo $VARIABLE_NAME</code>.  However, remember that unless you <code class="highlighter-rouge">export</code> these values they only temporarily exist in the console in which you issued the commands.  You may need to reissue the above commands later in the guide if you change terminal windows, so keep them handy.</p></div></div>
  </li>
  <li>
    <p>Download <a href="https://d3079gxvs8ayeg.cloudfront.net/templates/managed.yaml">this</a> <code class="highlighter-rouge">managed.yaml</code> template.  This template will create the <code class="highlighter-rouge">spinnakerManaged</code> <strong>AWS::IAM::Role</strong> that Spinnaker can use.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://d3079gxvs8ayeg.cloudfront.net/templates/managed.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Execute this secondary CloudFormation deployment using the <code class="highlighter-rouge">managed.yaml</code>.  Notice that this command (and many following commands) use some of the environmental variables we assigned previously, so the first stack deployment will need to be complete first.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> aws cloudformation deploy <span class="nt">--stack-name</span> spinnaker-managed-infrastructure-setup <span class="nt">--template-file</span> managed.yaml <span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM <span class="se">\</span>
 <span class="nt">--parameter-overrides</span> <span class="nv">AuthArn</span><span class="o">=</span><span class="nv">$AUTH_ARN</span> <span class="nv">ManagingAccountId</span><span class="o">=</span><span class="nv">$MANAGING_ACCOUNT_ID</span>
</code></pre></div>    </div>

    <div class="premonition info modified"><div class="fa fa-info-circle"></div><div class="content"><p>If the second step of deploying <code class="highlighter-rouge">spinnaker-managing-infrastructure-setup</code> hasn’t completed yet, feel free to skip this step for the time being and proceed with installing <code class="highlighter-rouge">kubectl</code> and <code class="highlighter-rouge">AWS IAM Authenticator</code> below.  Just return to this step before moving past that point.</p></div></div>
  </li>
</ol>

<h3 id="install-kubectl">Install Kubectl</h3>

<p>We’ll need to install the <code class="highlighter-rouge">kubectl</code> client and the <code class="highlighter-rouge">AWS IAM Authenticator for Kubernetes</code>, which will allow Amazon EKS to use IAM for authentication to our Kubernetes cluster.</p>

<ol>
  <li>
    <p>Download the appropriate <code class="highlighter-rouge">kubectl</code> binary.  <em>Note: For the remainder of this guide we’ll be using Linux examples, but most everything applies to other environments.</em></p>

    <ul>
      <li>Linux: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/kubectl</li>
      <li>MacOS: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/kubectl</li>
      <li>Windows: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/kubectl.exe</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/kubectl
</code></pre></div>    </div>
  </li>
  <li>
    <p>Change permissions of <code class="highlighter-rouge">kubectl</code> so it’s executable.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> chmod +x ./kubectl
</code></pre></div>    </div>
  </li>
  <li>
    <p>Move <code class="highlighter-rouge">kubectl</code> to an appropriate <code class="highlighter-rouge">bin</code> directory and add to your <code class="highlighter-rouge">PATH</code>, if necessary.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cp ./kubectl <span class="nv">$HOME</span>/bin/kubectl <span class="o">&amp;&amp;</span> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/bin:<span class="nv">$PATH</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify that <code class="highlighter-rouge">kubectl</code> is installed.  The <code class="highlighter-rouge">--client</code> flag is used here since we’re just checking for the local installation, not making any connections yet.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl version <span class="nt">--client</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="install-aws-iam-authenticator">Install AWS IAM Authenticator</h3>

<p>We’ll follow the same basic steps as above to install the AWS IAM Authenticator as well.</p>

<ol>
  <li>
    <p>Download the appropriate <code class="highlighter-rouge">aws-iam-authenticator</code> binary.</p>

    <ul>
      <li>Linux: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator</li>
      <li>MacOS: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator</li>
      <li>Windows: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/aws-iam-authenticator.exe</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator
</code></pre></div>    </div>
  </li>
  <li>
    <p>Make <code class="highlighter-rouge">aws-iam-authenticator</code> executable.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> chmod +x ./aws-iam-authenticator
</code></pre></div>    </div>
  </li>
  <li>
    <p>Move <code class="highlighter-rouge">aws352-iam-authenticator</code> to an appropriate <code class="highlighter-rouge">bin</code> directory and add to your <code class="highlighter-rouge">PATH</code>, if necessary.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cp ./aws-iam-authenticator <span class="nv">$HOME</span>/bin/aws-iam-authenticator <span class="o">&amp;&amp;</span> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/bin:<span class="nv">$PATH</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Test the <code class="highlighter-rouge">aws-iam-authenticator</code> installation.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> aws-iam-authenticator <span class="nb">help</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="configure-kubectl">Configure Kubectl</h3>

<p>The <a href="#setup-the-cloudformation-spinnaker-stack">CloudFormation Spinnaker Stack</a> setup step needs to be complete before proceeding.  With everything setup you can now edit the <code class="highlighter-rouge">kubectl</code> configuration files, which will inform <code class="highlighter-rouge">kubectl</code> how to connect to your Kubernetes/EKS cluster.</p>

<ol>
  <li>
    <p>Copy and paste the following into the <code class="highlighter-rouge">~/.kube/config</code> file.</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
 <span class="na">clusters</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
     <span class="na">server</span><span class="pi">:</span> <span class="s">&lt;endpoint-url&gt;</span>
     <span class="na">certificate-authority-data</span><span class="pi">:</span> <span class="s">&lt;base64-encoded-ca-cert&gt;</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">kubernetes</span>
 <span class="na">contexts</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
     <span class="na">cluster</span><span class="pi">:</span> <span class="s">kubernetes</span>
     <span class="na">user</span><span class="pi">:</span> <span class="s">aws</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
 <span class="na">current-context</span><span class="pi">:</span> <span class="s">aws</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
 <span class="na">preferences</span><span class="pi">:</span> <span class="pi">{}</span>
 <span class="na">users</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
   <span class="na">user</span><span class="pi">:</span>
     <span class="na">exec</span><span class="pi">:</span>
       <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">client.authentication.k8s.io/v1alpha1</span>
       <span class="na">command</span><span class="pi">:</span> <span class="s">aws-iam-authenticator</span>
       <span class="na">args</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">token"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">-i"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">&lt;cluster-name&gt;"</span>
         <span class="c1"># - "-r"</span>
         <span class="c1"># - "&lt;role-arn&gt;"</span>
       <span class="c1"># env:</span>
         <span class="c1"># - name: AWS_PROFILE</span>
         <span class="c1">#   value: "&lt;aws-profile&gt;"</span>
</code></pre></div>    </div>

    <div class="premonition info modified"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Configuring Multiple Kubernetes Clusters</p><p>This guide assumes you’re just configuring <code class="highlighter-rouge">kubectl</code> to handle a single Kubernetes cluster, but if you need to configure and handle multiple clusters the convention for doing so is to create a unique <code class="highlighter-rouge">config</code> file for each cluster.  Simply name each <code class="highlighter-rouge">config</code> file <code class="highlighter-rouge">~/.kube/config-&lt;cluster-name&gt;</code>, where <code class="highlighter-rouge">&lt;cluster-name&gt;</code> is replaced by the name of the Kubernetes cluster you already created.</p></div></div>
  </li>
  <li>
    <p>Replace the <code class="highlighter-rouge">&lt;...&gt;</code> placeholder strings with the following <code class="highlighter-rouge">EKS_CLUSTER_</code> environmental variable values from earlier:</p>

    <ul>
      <li><code class="highlighter-rouge">&lt;endpoint-url&gt;</code>: <code class="highlighter-rouge">$EKS_CLUSTER_ENDPOINT</code></li>
      <li><code class="highlighter-rouge">&lt;base64-encoded-ca-cert&gt;</code>: <code class="highlighter-rouge">$EKS_CLUSTER_CA_DATA</code></li>
      <li><code class="highlighter-rouge">&lt;cluster-name&gt;</code>: <code class="highlighter-rouge">$EKS_CLUSTER_NAME</code></li>
    </ul>

    <div class="premonition info modified"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Using a Specific `AWS::IAM::Role`</p><p>If you need to have the AWS IAM Authenticator and kubectl use a specific <code class="highlighter-rouge">Role</code> then uncomment the <code class="highlighter-rouge">- "-r"</code> and <code class="highlighter-rouge">- "&lt;role-arn&gt;"</code> lines and paste the <code class="highlighter-rouge">AWS::IAM::Role</code> ARN in place of <code class="highlighter-rouge">&lt;role-arn&gt;</code>.</p></div></div>
  </li>
  <li>
    <p>Your <code class="highlighter-rouge">~/.kube/config</code> file should now look something like this:</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
 <span class="na">clusters</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
     <span class="na">server</span><span class="pi">:</span> <span class="s">https://51A93D4A4B1228D6D06BE160DA2D3A8A.yl4.us-west-2.eks.amazonaws.com</span>
     <span class="na">certificate-authority-data</span><span class="pi">:</span> <span class="s">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRFNE1Ea3dOakExTVRnME1BHeGFNN3QyaApzcm8wa1ZOWTdCQ1g5YVBBY09rRFVuRExGektpZTJnZVZLOFpxVHJvZEpLR0p3SEtjVDJNNUtsR0ZTSjMzSGpoCk5ZeVErTnJkd0VKT2puR2xZN3R1eVFvZjhnNU0vNWZzZSt0TWFMTjJjQ3NWNFA1NCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFKN3owTEI5NFVoZWNwTUh0VGYrVTkxVDlxU2IKNWFVRGQrdlVTNEpVTWwwdk01OXBqc05CNDU1Z1l6ZkpLelZ1YXI5TjJOVURiREllNUJsbjlCRjWb1hEVEk0TURrd016QTFNVGcwTVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBT0h6CldrZ2pzTWZ0eEJYd3NZOGRuVXI5UUQTAzUVczazlaZHZlMWNYRlp4bHdqc3RSdWN3eUxRTG12eUh0VzJsTjE4RENqSXF5OGwxeUlYSENERQpXQjI3eHo4TXg3ZDJVSjIyaThjQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0V5OSTJHYjV4QU1vYjJBaWQwbEQrT2NncGdDcXQvQ3h2SlFJRGpxbjRKT1AKejh6RVkvWVVsQjBUOTVXUUFsRE9ZWnlKY3lDeWxYcFZRTnNDRWNSMFhUakRaVDFVbXMyMmk4NlozYy8xQ1IrWgpKNkNqZ3IvZkNadVVaV0VUbGt1WXhlSG5CQS91ZURJM1NsMVdnY0ZFMGFyNGxsVkVFVngyS01PZXhuM09FdHI0CjhBd1dmQWxzSUNXRWdjMjRKdzk5MG9LelNObXB0cWRaOEFwczhVaHJoZWtoNEh1blpFLzhud1prb213SE1TcTYKbjl5NFJN3RyR0xWN0RzMUxWUFBlWjkKVVB0eU1WODlieFVEeFhNV3I3d2tNRy9YckdtaC9nN1gwb1grdXRnUUtiSWdPaHZMZEFKSDNZUUlyTjhHS0krcwpIMGtjTnpYMWYzSGdabUVINUIxNXhER0R2SnA5a045Q29VdjRYVE5tdlljVlNVSy9vcWdwaXd1TU9oZz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">kubernetes</span>
 <span class="na">contexts</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
     <span class="na">cluster</span><span class="pi">:</span> <span class="s">kubernetes</span>
     <span class="na">user</span><span class="pi">:</span> <span class="s">aws</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
 <span class="na">current-context</span><span class="pi">:</span> <span class="s">aws</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
 <span class="na">preferences</span><span class="pi">:</span> <span class="pi">{}</span>
 <span class="na">users</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
   <span class="na">user</span><span class="pi">:</span>
     <span class="na">exec</span><span class="pi">:</span>
       <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">client.authentication.k8s.io/v1alpha1</span>
       <span class="na">command</span><span class="pi">:</span> <span class="s">aws-iam-authenticator</span>
       <span class="na">args</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">token"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">-i"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">spinnaker-cluster"</span>
         <span class="c1"># - "-r"</span>
         <span class="c1"># - "&lt;role-arn&gt;"</span>
       <span class="c1"># env:</span>
         <span class="c1"># - name: AWS_PROFILE</span>
         <span class="c1">#   value: "&lt;aws-profile&gt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Save your <code class="highlighter-rouge">config</code> file and export the <code class="highlighter-rouge">KUBECONFIG</code> variable to include the new <code class="highlighter-rouge">config</code> location.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$KUBECONFIG</span>:~/.kube/config
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify that <code class="highlighter-rouge">kubectl</code> is able to use your credentials to connect to your cluster with <code class="highlighter-rouge">kubectl get svc</code>:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>kubectl get svc

 NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
 kubernetes   ClusterIP   172.25.0.1   &lt;none&gt;        443/TCP   31m
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="create-aws-accounts-and-roles">Create AWS Accounts and Roles</h3>

<p>We now need to apply service accounts and roles to the <code class="highlighter-rouge">kubectl</code> <code class="highlighter-rouge">spinnaker</code> namespace.  In Kubernetes, a <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a> is a <em>virtual</em> cluster, which can join other virtual clusters and all be housed within the same <em>physical</em> cluster.</p>

<ol>
  <li>
    <p>Issue the following commands to create the <code class="highlighter-rouge">spinnaker</code> namespace, <code class="highlighter-rouge">spinnaker-service-account</code> service account, and <code class="highlighter-rouge">spinnaker-admin</code> binding.  The <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#apply"><code class="highlighter-rouge">apply</code></a> command in <code class="highlighter-rouge">kubectl</code> applies a configuration based on the passed resource (YAML files, in this case).</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">CONTEXT</span><span class="o">=</span>aws
 kubectl create namespace spinnaker
 kubectl apply <span class="nt">-f</span> https://d3079gxvs8ayeg.cloudfront.net/templates/spinnaker-service-account.yaml
 kubectl apply <span class="nt">-f</span> https://d3079gxvs8ayeg.cloudfront.net/templates/spinnaker-cluster-role-binding.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Next, we’re creating the authentication <code class="highlighter-rouge">TOKEN</code> environmental variable.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>kubectl get secret <span class="nt">--context</span> <span class="nv">$CONTEXT</span> <span class="se">\</span>
   <span class="k">$(</span>kubectl get serviceaccount spinnaker-service-account <span class="se">\</span>
       <span class="nt">--context</span> <span class="nv">$CONTEXT</span> <span class="se">\</span>
       <span class="nt">-n</span> spinnaker <span class="se">\</span>
       <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.secrets[0].name}'</span><span class="k">)</span> <span class="se">\</span>
   <span class="nt">-n</span> spinnaker <span class="se">\</span>
   <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.data.token}'</span> | base64 <span class="nt">--decode</span><span class="k">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Pass the <code class="highlighter-rouge">TOKEN</code> to the following configuration commands to set <code class="highlighter-rouge">kubectl</code> credentials.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl config set-credentials <span class="k">${</span><span class="nv">CONTEXT</span><span class="k">}</span><span class="nt">-token-user</span> <span class="nt">--token</span> <span class="nv">$TOKEN</span>
 kubectl config set-context <span class="nv">$CONTEXT</span> <span class="nt">--user</span> <span class="k">${</span><span class="nv">CONTEXT</span><span class="k">}</span><span class="nt">-token-user</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="add-kubernetes-provider-to-halyard">Add Kubernetes Provider to Halyard</h3>

<p>The next step is to add Kubernetes as a provider to Halyard/Spinnaker. A <a href="https://www.spinnaker.io/concepts/providers/">provider</a> is just an interface to one of many virtual resources Spinnaker will utilize.  AWS, Azure, Docker, and many more are all considered providers, and are managed by Spinnaker via <code class="highlighter-rouge">accounts</code>.</p>

<ol>
  <li>
    <p>Start by enabling the Kubernetes provider in Halyard.4</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> hal config provider kubernetes <span class="nb">enable</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add the <code class="highlighter-rouge">kubernetes-master</code> account to Halyard.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> hal config provider kubernetes account add kubernetes-master <span class="nt">--provider-version</span> v2 <span class="nt">--context</span> <span class="k">$(</span>kubectl config current-context<span class="k">)</span><span class="sb">`</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Enable the <code class="highlighter-rouge">artifacts</code> and <code class="highlighter-rouge">chaos</code> features of Halyard.  <a href="https://www.spinnaker.io/reference/artifacts/">Artifacts</a> in Spinnaker merely reference any external resource, such as a remote file, a binary blob, and image, and so forth.  The <code class="highlighter-rouge">chaos</code> feature allows us to utilize Chaos Monkey, the base form of which is built into Spinnaker by default.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> hal config features edit <span class="nt">--artifacts</span> <span class="nb">true
 </span>hal config features edit <span class="nt">--chaos</span> <span class="nb">true</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="add-aws-provider-to-halyard">Add AWS Provider to Halyard</h3>

<p>Now we need to also add AWS as another provider and account.  Be sure to replace <code class="highlighter-rouge">&lt;AWS_ACCOUNT_ID&gt;</code> with the primary/managing account ID of your AWS account.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config provider aws account add aws-primary <span class="nt">--account-id</span> &lt;AWS_ACCOUNT_ID&gt; <span class="nt">--assume-role</span> role/spinnakerManaged
hal config provider aws <span class="nb">enable</span>
</code></pre></div></div>

<h3 id="add-ecs-provider-to-halyard">Add ECS Provider to Halyard</h3>

<p>The last provider to enable is ECS.  We’ll add the <code class="highlighter-rouge">ecs-primary</code> account to Halyard and associate it with the <code class="highlighter-rouge">aws-primary</code> AWS account added above:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config provider ecs account add ecs-primary <span class="nt">--aws-account</span> aws-primary
hal config provider ecs <span class="nb">enable</span>
</code></pre></div></div>

<h3 id="use-distributed-deployment">Use Distributed Deployment</h3>

<p>We also need to ensure Halyard deploys Spinnaker in a distributed fashion among our Kubernetes cluster.  Without this step, the default configuration is to deploy Spinnaker onto the local machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config deploy edit <span class="nt">--type</span> distributed <span class="nt">--account-name</span> kubernetes-master
</code></pre></div></div>

<div class="premonition error modified"><div class="fa fa-exclamation-triangle"></div><div class="content"><p class="header">Error: `kubectl` not installed, or can't be found by Halyard.</p><p>If you get such an error when issuing the distributed deployment command above, it likely means Halyard just needs to be restarted.  Simply issue the <code class="highlighter-rouge">hal shutdown</code> command to stop the Halyard daemon, then retry the deployment edit command again, which will automatically restart Halyard before executing.</p></div></div>

<h3 id="use-s3-for-persistent-storage">Use S3 for Persistent Storage</h3>

<p>Let’s tell Spinnaker to use AWS S3 for storing persistent data (in this case, creating a small S3 bucket).  Issue the following command by replacing <code class="highlighter-rouge">&lt;AWS_ACCESS_KEY_ID&gt;</code> with any AWS access key that has full S3 service privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config storage s3 edit <span class="nt">--access-key-id</span> &lt;AWS_ACCESS_KEY_ID&gt; <span class="nt">--secret-access-key</span> <span class="nt">--region</span> us-west-2
hal config storage edit <span class="nt">--type</span> s3
</code></pre></div></div>

<h3 id="create-kubernetes-worker-nodes">Create Kubernetes Worker Nodes</h3>

<p>Now we’ll launch some AWS EC2 instances which will be our worker nodes for our Kubernetes cluster to manage.</p>

<ol>
  <li>
    <p>Download <a href="https://d3079gxvs8ayeg.cloudfront.net/templates/amazon-eks-nodegroup.yaml">this</a> <code class="highlighter-rouge">amazon-eks-nodegroup.yml</code> template file.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://d3079gxvs8ayeg.cloudfront.net/templates/amazon-eks-nodegroup.yaml
</code></pre></div>    </div>

    <div class="premonition info modified"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Adjust Worker Nodes</p><p>The default template creates an auto-balancing collection of up to <strong>3</strong> worker nodes (instances).  Additionally, the deployment command we’ll be using below specifies <code class="highlighter-rouge">t2.large</code> instance types.  As always, feel free to modify the <code class="highlighter-rouge">amazon-eks-nodegroup.yaml</code> or instance types to meet your needs.</p></div></div>
  </li>
  <li>
    <p>Issue the following command to use the template and create your worker node collection.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> aws cloudformation deploy <span class="nt">--stack-name</span> spinnaker-eks-nodes <span class="nt">--template-file</span> amazon-eks-nodegroup.yaml <span class="se">\</span>
 <span class="nt">--parameter-overrides</span> <span class="nv">NodeInstanceProfile</span><span class="o">=</span><span class="nv">$SPINNAKER_INSTANCE_PROFILE_ARN</span> <span class="se">\</span>
 <span class="nv">NodeInstanceType</span><span class="o">=</span>t2.large <span class="nv">ClusterName</span><span class="o">=</span><span class="nv">$EKS_CLUSTER_NAME</span> <span class="nv">NodeGroupName</span><span class="o">=</span>spinnaker-cluster-nodes <span class="nv">ClusterControlPlaneSecurityGroup</span><span class="o">=</span><span class="nv">$CONTROL_PLANE_SG</span> <span class="se">\</span>
 <span class="nv">Subnets</span><span class="o">=</span><span class="nv">$SUBNETS</span> <span class="nv">VpcId</span><span class="o">=</span><span class="nv">$VPC_ID</span> <span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM
</code></pre></div>    </div>
  </li>
  <li>
    <p>To connect up our newly-launched worker instances with the Spinnaker cluster we previously deployed we need to create a new <code class="highlighter-rouge">~/.kube/aws-auth-cm.yaml</code> file.  Paste the following text into <code class="highlighter-rouge">aws-auth-cm.yaml</code>, replacing <code class="highlighter-rouge">&lt;AUTH_ARN&gt;</code> with the <code class="highlighter-rouge">AUTH_ARN</code> variable created previously (Remember, you can use <code class="highlighter-rouge">echo $AUTH_ARN</code> to print to console).</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
 <span class="na">metadata</span><span class="pi">:</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">aws-auth</span>
   <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
 <span class="na">data</span><span class="pi">:</span>
   <span class="na">mapRoles</span><span class="pi">:</span> <span class="pi">|</span>
     <span class="no">- rolearn: &lt;AUTH_ARN&gt;</span>
       <span class="no">username: system:node:</span>
       <span class="no">groups:</span>
         <span class="no">- system:bootstrappers</span>
         <span class="no">- system:nodes</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Apply this newly created role mapping by issuing the following command.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl apply <span class="nt">-f</span> ~/.kube/aws-auth-cm.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Check the status of your Kubernetes nodes with <code class="highlighter-rouge">kubectl get nodes</code>.  The <code class="highlighter-rouge">--watch</code> flag can be added to perform constant updates.  Once all nodes have a <code class="highlighter-rouge">Ready</code> <strong>STATUS</strong> you’re all set to deploy Spinnaker.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl get nodes
 NAME                                          STATUS    ROLES     AGE       VERSION
 ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    2m        v1.10.3
 ip-10-100-10-210.us-west-2.compute.internal   Ready     &lt;none&gt;    2m        v1.10.3
 ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    2m        v1.10.3
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="deploy-spinnaker">Deploy Spinnaker</h3>

<ol>
  <li>
    <p>Start by listing the current Spinnaker versions with <code class="highlighter-rouge">hal version list</code>:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> hal version list
 + Get current deployment
   Success
 + Get Spinnaker version
   Success
 + Get released versions
   Success
 + You are on version <span class="s2">""</span>, and the following are available:
 - 1.7.8 <span class="o">(</span>Ozark<span class="o">)</span>:
   Changelog: https://gist.github.com/spinnaker-release/75f98544672a4fc490d451c14688318e
   Published: Wed Aug 29 19:09:57 UTC 2018
   <span class="o">(</span>Requires Halyard <span class="o">&gt;=</span> 1.0.0<span class="o">)</span>
 - 1.8.6 <span class="o">(</span>Dark<span class="o">)</span>:
   Changelog: https://gist.github.com/spinnaker-release/0844fadacaf2299d214a82e88217d97c
   Published: Wed Aug 29 19:11:34 UTC 2018
   <span class="o">(</span>Requires Halyard <span class="o">&gt;=</span> 1.0.0<span class="o">)</span>
 - 1.9.2 <span class="o">(</span>Bright<span class="o">)</span>:
   Changelog: https://gist.github.com/spinnaker-release/9323c90ab2088d89e68ce2a7ef7e5809
   Published: Wed Aug 29 20:08:18 UTC 2018
   <span class="o">(</span>Requires Halyard <span class="o">&gt;=</span> 1.0.0<span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Specify the version you wish to install with the <code class="highlighter-rouge">--version</code> flag below.  We’ll be using the latest at the time of writing, <code class="highlighter-rouge">1.9.2</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> hal config version edit <span class="nt">--version</span> 1.9.2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now use <code class="highlighter-rouge">hal deploy apply</code> to deploy Spinnaker using all the configuration settings we’ve previously applied.  This will go about distributing Spinnaker in your EKS/Kubernetes cluster.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> hal deploy apply
</code></pre></div>    </div>

    <div class="premonition error modified"><div class="fa fa-exclamation-triangle"></div><div class="content"><p class="header">Handling `hal deploy apply` Errors</p><p>In some cases you may experience a deployment error, particularly when trying your first Spinnaker deployment.  Often the console output is quite vague, so the best course of action is to check your Spinnaker/Halyard log files.  Typically these are located in <code class="highlighter-rouge">/var/log/spinnaker</code> and <code class="highlighter-rouge">/var/log/spinnaker/halyard</code>.  Since Halyard runs on Java, logs let you see the entire Java error stack trace, rather than the basic (and often useless) error name.</p></div></div>

    <div class="premonition error modified"><div class="fa fa-exclamation-triangle"></div><div class="content"><p class="header">Profile-related `IndexOutOfBoundsException`</p><p>With recent Halyard/Spinnaker versions there’s a <a href="https://github.com/spinnaker/spinnaker/issues/3280">known bug</a> that you may experience in which an <code class="highlighter-rouge">IndexOutOfBoundsException</code> occurs during deployment when using the AWS provider.  The cause usually seems to be that Halyard is assuming an explicit <code class="highlighter-rouge">region</code> value in the YAML configuration file for the AWS account being used.  Even though the <code class="highlighter-rouge">aws</code> block in the config has a <code class="highlighter-rouge">defaultRegions</code> key, that seems to be ignored, which can cause this error.  The current solution is to manually edit the primary AWS account and explicitly set the <code class="highlighter-rouge">region</code> value, which should solve the issue and allow you to run a Spinnaker deployment.</p></div></div>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config provider aws account edit aws-primary <span class="nt">--add-region</span> us-west-2
</code></pre></div></div>

<p>That’s it, you should now have a Spinnaker deployment up and running on a Kubernetes cluster, using EKS and EC2 worker node instances!  Issue the <code class="highlighter-rouge">hal deploy connect</code> command to provide port forwarding on your local machine to the Kubernetes cluster running Spinnaker, then open <a href="http://localhost:9000">http://localhost:9000</a> to make sure everything is up and running.</p>

<p>Select the <code class="highlighter-rouge">spinnaker</code> app and you should see your <code class="highlighter-rouge">aws-primary</code> account with a <code class="highlighter-rouge">spinnaker-eks-nodes-NodeGroup</code> containing your three EC2 worker node instances.</p>

<p><img src="/gremlin-chaos-monkey/images/advanced-tips-kubernetes-spinnaker.png" alt="advanced-tips-kubernetes-spinnaker" /></p>

<h2 id="using-chaos-monkey-on-kubernetes">Using Chaos Monkey on Kubernetes</h2>

<h3 id="install-mysql">Install MySQL</h3>

<p>Chaos Monkey requires MySQL 5.6/5.7 to run, so make sure you install it on your local system if necessary.</p>

<div class="premonition warning modified"><div class="fa fa-exclamation-circle"></div><div class="content"><p class="header">Warning</p><p>Chaos Monkey is currently <em>incompatible</em> with MySQL version 8.0 or higher due to the removal of a value that Chaos Monkey binary tries to reference.</p></div></div>

<ol>
  <li>
    <p>Download the latest <code class="highlighter-rouge">mysql-apt.deb</code> file from the <a href="https://dev.mysql.com/downloads/repo/apt/">official website</a>, which we’ll use to install MySQL</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl <span class="nt">-OL</span> https://dev.mysql.com/get/mysql-apt-config_0.8.10-1_all.deb
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install <code class="highlighter-rouge">mysql-server</code> by using the <code class="highlighter-rouge">dpkg</code> command.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>dpkg <span class="nt">-i</span> mysql-apt-config_0.8.10-1_all.deb
</code></pre></div>    </div>
  </li>
  <li>
    <p>In the UI that appears press enter to change the <strong>MySQL Server &amp; Cluster</strong> version to <code class="highlighter-rouge">mysql-5.7</code>.  Leave the other options as default and move down to <code class="highlighter-rouge">Ok</code> and press <code class="highlighter-rouge">Enter</code> to finalize your choice.</p>

    <p><img src="/gremlin-chaos-monkey/images/advanced-tips-mysql-install.png" alt="advanced-tips-mysql-install" /></p>
  </li>
  <li>
    <p>Now use <code class="highlighter-rouge">sudo apt-get update</code> to update the MySQL packages related to the version we selected (<code class="highlighter-rouge">mysql-5.7</code>, in this case).</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>apt-get update
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install <code class="highlighter-rouge">mysql-server</code> from the packages we just retrieved.  You’ll be prompted to enter a <code class="highlighter-rouge">root</code> password.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>apt-get install mysql-server
</code></pre></div>    </div>
  </li>
  <li>
    <p>You’re all set.  Check that MySQL server is running with <code class="highlighter-rouge">systemctl</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> systemctl status mysql
</code></pre></div>    </div>
  </li>
  <li>
    <p>(Optional) You may also wish to issue the <code class="highlighter-rouge">mysql_secure_installation</code> command, which will walk you through a few security-related prompts.  Typically, the defaults are just fine.</p>
  </li>
</ol>

<h3 id="setup-mysql-for-chaos-monkey">Setup MySQL for Chaos Monkey</h3>

<p>We now need to add a MySQL table for Chaos Monkey to use and create an associated user with appropriate permissions.</p>

<ol>
  <li>
    <p>Launch the <code class="highlighter-rouge">mysql</code> CLI as the <code class="highlighter-rouge">root</code> user.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> mysql <span class="nt">-u</span> root <span class="nt">-p</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create a <code class="highlighter-rouge">chaosmonkey</code> database for Chaos Monkey to use.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> CREATE DATABASE chaosmonkey<span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add a <code class="highlighter-rouge">chaosmonkey</code> MySQL user.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> CREATE USER <span class="s1">'chaosmonkey'</span>@<span class="s1">'localhost'</span> IDENTIFIED BY <span class="s1">'password'</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Grant all privileges in the <code class="highlighter-rouge">chaosmonkey</code> database to the new <code class="highlighter-rouge">chaosmonkey</code> user.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> GRANT ALL PRIVILEGES ON chaosmonkey.<span class="k">*</span> TO <span class="s1">'chaosmonkey'</span>@<span class="s1">'localhost'</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Finally, save all changes made to the system.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> FLUSH PRIVILEGES<span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="install-chaos-monkey">Install Chaos Monkey</h3>

<ol>
  <li>
    <p>(Optional) Install <code class="highlighter-rouge">go</code> if you don’t have it on your local machine already.</p>

    <ol>
      <li>
        <p>Go to <a href="https://golang.org/dl/">this</a> download page and download the latest binary appropriate to your environment.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://dl.google.com/go/go1.11.linux-amd64.tar.gz
</code></pre></div>        </div>
      </li>
      <li>
        <p>Extract the archive to the <code class="highlighter-rouge">/usr/local</code> directory.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo tar</span> <span class="nt">-C</span> /usr/local <span class="nt">-xzf</span> go1.11.linux-amd64.tar.gz
</code></pre></div>        </div>
      </li>
      <li>
        <p>Add <code class="highlighter-rouge">/usr/local/go/bin</code> to your <code class="highlighter-rouge">$PATH</code> environment variable.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/go/bin
 <span class="nb">echo</span> <span class="s1">'export PATH=$PATH:/usr/local/go/bin'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>
    <p>(Optional) Check if your <code class="highlighter-rouge">$GOPATH</code> &amp; <code class="highlighter-rouge">$GOBIN</code> variables are set with <code class="highlighter-rouge">echo $GOPATH</code> and <code class="highlighter-rouge">echo $GOBIN</code>.  If not, <code class="highlighter-rouge">export</code> them and add to your bash profile.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/go
 <span class="nb">echo</span> <span class="s1">'export GOPATH=$HOME/go'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
 <span class="nb">export </span><span class="nv">GOBIN</span><span class="o">=</span><span class="nv">$HOME</span>/go/bin
 <span class="nb">echo</span> <span class="s1">'export GOBIN=$HOME/go/bin'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
 <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$GOBIN</span>
 <span class="nb">echo</span> <span class="s1">'export PATH=$PATH:$GOBIN'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install the latest Chaos Monkey binary.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> go get github.com/netflix/chaosmonkey/cmd/chaosmonkey
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="configure-chaos-monkey-on-spinnaker">Configure Chaos Monkey on Spinnaker</h3>

<p>Since we already enabled the <code class="highlighter-rouge">chaos</code> feature of Spinnaker prior to deployment, we can add Chaos Monkey support to our <code class="highlighter-rouge">spinnaker</code> application fairly easily.</p>

<ol>
  <li>
    <p>Navigate to <strong>Applications &gt; spinnaker &gt; CONFIG</strong> and select <strong>CHAOS MONKEY</strong> in the side navigation.</p>

    <p><img src="/gremlin-chaos-monkey/images/advanced-tips-config-chaos-monkey.png" alt="advanced-tips-config-chaos-monkey" /></p>
  </li>
  <li>Check the <strong>Enabled</strong> box to enable Chaos Monkey.</li>
  <li>The UI provides useful information for what every option does, but the most important options are the <strong>mean</strong> and <strong>min</strong> times between instance termination.  If your setup includes multiple clusters or stacks, altering the <strong>grouping</strong> may also make sense.  Finally, you can add <strong>exceptions</strong> as necessary, which acts as a kind of <em>whitelist</em> of instances that will be ignored by Chaos Monkey, so you can keep the most critical services up and running.</li>
  <li>Once your changes are made click the <strong>Save Changes</strong> button.</li>
</ol>

<h2 id="how-to-deploy-chaos-monkey">How to Deploy Chaos Monkey</h2>

<ol>
  <li>Start by creating the <code class="highlighter-rouge">chaosmonkey.toml</code> configuration file in the director of your choice.  Chaos Monkey looks for such a file in four different locations, until a configuration is found:
    <ul>
      <li><em>(current directory)</em></li>
      <li><code class="highlighter-rouge">/apps/chaosmonkey</code></li>
      <li><code class="highlighter-rouge">/etc</code></li>
      <li><code class="highlighter-rouge">/etc/chaosmonkey</code></li>
    </ul>
  </li>
</ol>

<div class="premonition tip modified"><div class="fa fa-check-square"></div><div class="content"><p>Generally, if you’re configuring <em>multiple</em> Chaos Monkey installations on the same machine you should use application-specific configurations, so putting them in separate directories is ideal.  However, if you’re just using one installation on the machine then <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey.toml</code> works well.</p></div></div>

<ol>
  <li>
    <p>Add the following basic configuration structure to your <code class="highlighter-rouge">chaosmonkey.toml</code> file, replacing appropriate <code class="highlighter-rouge">&lt;DATABASE_&gt;</code> configuration values with your own settings.</p>

    <div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nn">[chaosmonkey]</span>
 <span class="py">enabled</span> <span class="p">=</span> <span class="kc">true</span>
 <span class="py">schedule_enabled</span> <span class="p">=</span> <span class="kc">true</span>
 <span class="py">leashed</span> <span class="p">=</span> <span class="kc">false</span>
 <span class="py">accounts</span> <span class="p">=</span> <span class="nn">["aws-primary"]</span>

 <span class="py">start_hour</span> <span class="p">=</span> <span class="mi">9</span>      <span class="c"># time during day when starts terminating</span>
 <span class="py">end_hour</span> <span class="p">=</span> <span class="mi">15</span>       <span class="c"># time during day when stops terminating</span>

 <span class="c"># location of command Chaos Monkey uses for doing terminations</span>
 <span class="py">term_path</span> <span class="p">=</span> <span class="s">"/apps/chaosmonkey/chaosmonkey-terminate.sh"</span>

 <span class="c"># cron file that Chaos Monkey writes to each day for scheduling kills</span>
 <span class="py">cron_path</span> <span class="p">=</span> <span class="s">"/etc/cron.d/chaosmonkey-schedule"</span>

 <span class="nn">[database]</span>
 <span class="py">host</span> <span class="p">=</span> <span class="s">"localhost"</span>
 <span class="py">name</span> <span class="p">=</span> <span class="s">"&lt;DATABASE_NAME&gt;"</span>
 <span class="py">user</span> <span class="p">=</span> <span class="s">"&lt;DATABASE_USER&gt;"</span>
 <span class="py">encrypted_password</span> <span class="p">=</span> <span class="s">"&lt;DATABASE_USER_PASSWORD&gt;"</span>

 <span class="nn">[spinnaker]</span>
 <span class="py">endpoint</span> <span class="p">=</span> <span class="s">"http://localhost:8084"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>With Chaos Monkey configured it’s time to migrate it to the MySQL</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> chaosmonkey migrate
 <span class="o">[</span>16264] 2018/09/04 14:11:16 Successfully applied database migrations. Number of migrations applied:  1
 <span class="o">[</span>16264] 2018/09/04 14:11:16 database migration applied successfully
</code></pre></div>    </div>
  </li>
</ol>

<div class="premonition error modified"><div class="fa fa-exclamation-triangle"></div><div class="content"><p class="header">Error: 1298: Unknown or incorrect time zone: 'UTC'</p><p>If you experience a timezone error this typically indicates a configuration problem with MySQL.  Just run the <code class="highlighter-rouge">mysql_tzinfo_to_sql</code> command to update your MySQL installation.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql_tzinfo_to_sql /usr/share/zoneinfo/|mysql <span class="nt">-u</span> root mysql <span class="nt">-p</span>
</code></pre></div></div></div></div>

<h2 id="using-chaos-monkey">Using Chaos Monkey</h2>

<p>Using the <code class="highlighter-rouge">chaosmonkey</code> command line tool is fairly simple.  Start by making sure it can connect to your <code class="highlighter-rouge">spinnaker</code> instance with <code class="highlighter-rouge">chaosmonkey config spinnaker</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chaosmonkey config spinnaker
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OUTPUT</span>
<span class="o">(</span><span class="k">*</span>chaosmonkey.AppConfig<span class="o">)(</span>0xc00006ca00<span class="o">)({</span>
 Enabled: <span class="o">(</span>bool<span class="o">)</span> <span class="nb">true</span>,
 RegionsAreIndependent: <span class="o">(</span>bool<span class="o">)</span> <span class="nb">true</span>,
 MeanTimeBetweenKillsInWorkDays: <span class="o">(</span>int<span class="o">)</span> 2,
 MinTimeBetweenKillsInWorkDays: <span class="o">(</span>int<span class="o">)</span> 1,
 Grouping: <span class="o">(</span>chaosmonkey.Group<span class="o">)</span> cluster,
 Exceptions: <span class="o">([]</span>chaosmonkey.Exception<span class="o">)</span> <span class="o">{</span>
 <span class="o">}</span>,
 Whitelist: <span class="o">(</span><span class="k">*</span><span class="o">[]</span>chaosmonkey.Exception<span class="o">)(</span>&lt;nil&gt;<span class="o">)</span>
<span class="o">})</span>
</code></pre></div></div>

<p>Now it’s time to test termination.  Remember that we can use the <code class="highlighter-rouge">kubectl get nodes --watch</code> command to keep watch of our Kubernetes nodes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes <span class="nt">--watch</span>
</code></pre></div></div>

<p>You’ll see an output similar to the following.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OUTPUT</span>
ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-210.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
</code></pre></div></div>

<p>To manually terminate an instance with Chaos Monkey we use the <code class="highlighter-rouge">chaosmonkey terminate</code> command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chaosmonkey terminate &lt;app&gt; &lt;account&gt; <span class="o">[</span><span class="nt">--region</span><span class="o">=</span>&lt;region&gt;] <span class="o">[</span><span class="nt">--stack</span><span class="o">=</span>&lt;stack&gt;] <span class="o">[</span><span class="nt">--cluster</span><span class="o">=</span>&lt;cluster&gt;] <span class="o">[</span><span class="nt">--leashed</span><span class="o">]</span>
</code></pre></div></div>

<p>For this guide our <strong>app</strong> is <code class="highlighter-rouge">spinnaker</code> and our <strong>account</strong> is <code class="highlighter-rouge">aws-primary</code>, so using just those two values and leaving the rest default should work.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chaosmonkey terminate spinnaker aws-primary
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OUTPUT</span>
<span class="o">[</span>11533] 2018/09/08 18:39:26 Picked: <span class="o">{</span>spinnaker aws-primary us-west-2 eks spinnaker-eks-nodes-NodeGroup-KLBYTZDP0F89 spinnaker-eks-nodes-NodeGroup-KLBYTZDP0F89 i-054152fc4ed41d7b7 aws<span class="o">}</span>
</code></pre></div></div>

<p>Now look back at the terminal window running <code class="highlighter-rouge">kubectl get nodes --watch</code> and after a moment you’ll see one of the nodes has been terminated.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-210.us-west-2.compute.internal   NotReady   &lt;none&gt;    3d        v1.10.3
ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
</code></pre></div></div>

<p><img src="https://media.giphy.com/media/3ohzdIuqJoo8QdKlnW/giphy.gif" alt="awesome-gif" /></p>

<p>If you quickly open up your Spinnaker Deck UI you’ll see only two of the three instances in the cluster are active, as we see in <code class="highlighter-rouge">kubectl</code> above.  However, wait a few more moments and Spinnaker will notice the loss of an instance, recognize it has been stopped/terminated due to an EC2 health check, and will immediately propagate a new instance to replace it, thus ensuring the server group’s desired capacity remains at <code class="highlighter-rouge">3</code> instances.</p>

<p>The <code class="highlighter-rouge">kubectl get nodes --watch</code> output confirms this (in this case, the new local <code class="highlighter-rouge">ip-10-100-11-180.us-west-2.compute.internal</code> instance was added).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-11-180.us-west-2.compute.internal   NotReady   &lt;none&gt;    10s       v1.10.3
ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-11-180.us-west-2.compute.internal   Ready     &lt;none&gt;    20s       v1.10.3
</code></pre></div></div>

<p>Spinnaker also tracks this information.  Navigating to the <strong><code class="highlighter-rouge">spinnaker</code> app &gt; INFRASTRUCTURE &gt; CLUSTERS &gt; <code class="highlighter-rouge">spinnaker-eks-nodes-NodeGroup</code> &gt; CAPACITY</strong> and click <strong>View Scaling Activities</strong> to see the Spinnaker scaling activities log for this node group.  In this case we see the successful activities that lead to the health check failure and new instance start.</p>

<p><img src="/gremlin-chaos-monkey/images/advanced-tips-nodegroup-scaling-activities.png" alt="advanced-tips-nodegroup-scaling-activities" /></p>

<h3 id="scheduling-chaos-monkey-terminations">Scheduling Chaos Monkey Terminations</h3>

<p>Before we get to scheduling anything you’ll want to copy the <code class="highlighter-rouge">chaosmonkey</code> executable to the <code class="highlighter-rouge">/apps/chaosmonkey</code> directory.  While you can leave it in the default <code class="highlighter-rouge">$GOBIN</code> directory, it’ll be easier to use with cron jobs and other system commands if it’s in a global location.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>cp ~/go/bin/chaosmonkey /apps/chaosmonkey/
</code></pre></div></div>

<p>Now that we’ve confirmed we can manually terminate instances via Chaos Monkey you may want to setup an automated system for doing so.  The primary way to do this is to create a series of scripts that regenerate a unique <code class="highlighter-rouge">crontab</code> job that is scheduled to execute on a specific date and time.  This cron job is created every day (or however often you like), and the execution time is randomized based on the <code class="highlighter-rouge">start_hour</code>, <code class="highlighter-rouge">end_hour</code>, and <code class="highlighter-rouge">time_zone</code> settings in the <code class="highlighter-rouge">chaosmonkey.toml</code> configuration.  We’ll be using four files for this: Two crontab files and two bash scripts.</p>

<ul>
  <li><code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-schedule.sh</code>:</li>
  <li><code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-terminate.sh</code>:</li>
  <li><code class="highlighter-rouge">/etc/cron.d/chaosmonkey-schedule</code>:</li>
  <li><code class="highlighter-rouge">/etc/cron.d/chaosmonkey-daily-scheduler</code>:</li>
</ul>

<ol>
  <li>
    <p>Start by creating the four files we’ll be using for this.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>touch /apps/chaosmonkey/chaosmonkey-schedule.sh
 <span class="nb">sudo </span>touch /apps/chaosmonkey/chaosmonkey-terminate.sh
 <span class="nb">sudo </span>touch /etc/cron.d/chaosmonkey-schedule
 <span class="nb">sudo </span>touch /etc/cron.d/chaosmonkey-daily-scheduler
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now set executable permissions for the two bash scripts so the cron (root) user doesn’t have permissions problems.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>chmod a+rx /apps/chaosmonkey/chaosmonkey-schedule.sh
 <span class="nb">sudo </span>chmod a+rx /apps/chaosmonkey/chaosmonkey-terminate.sh
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now we’ll add some commands to each script in the order they’re expected to call one another.  First, the <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-daily-scheduler</code> is executed once a day at a time you specify.  This will call the <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-schedule.sh</code> script, which will perform the actual scheduling for termination.  Paste the following into <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-daily-scheduler</code> (as with any cron job you can freely edit the schedule to determine when the cron job should be executed).</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c"># min  hour  dom  month  day  user  command</span>
 0      12    <span class="k">*</span>    <span class="k">*</span>      <span class="k">*</span>    root  /apps/chaosmonkey/chaosmonkey-schedule.sh
</code></pre></div>    </div>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-schedule.sh</code> should perform the actual <code class="highlighter-rouge">chaosmonkey schedule</code> command, so paste the following into <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-schedule.sh</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 /apps/chaosmonkey/chaosmonkey schedule <span class="o">&gt;&gt;</span> /var/log/chaosmonkey-schedule.log 2&gt;&amp;1
</code></pre></div>    </div>
  </li>
  <li>
    <p>When the <code class="highlighter-rouge">chaosmonkey schedule</code> command is called by the <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-schedule.sh</code> script it will automatically write to the <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-schedule</code> file with a randomized timestamp for execution based on the Chaos Monkey configuration.  Here’s an example of what the generated <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-schedule</code> looks like.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c"># /etc/cron.d/chaosmonkey-schedule</span>
 9 16 9 9 0 root /apps/chaosmonkey/chaosmonkey-terminate.sh spinnaker aws-primary <span class="nt">--cluster</span><span class="o">=</span>spinnaker-eks-nodes-NodeGroup-KLBYTZDP0F89 <span class="nt">--region</span><span class="o">=</span>us-west-2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Lastly, the <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-terminate.sh</code> script that is called by the generated <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-schedule</code> cron job should issue the <code class="highlighter-rouge">chaosmonkey terminate</code> command and output the result to the log.  Paste the following into ``/apps/chaosmonkey/chaosmonkey-terminate.sh`.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 /apps/chaosmonkey/chaosmonkey terminate <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /var/log/chaosmonkey-terminate.log 2&gt;&amp;1
</code></pre></div>    </div>
  </li>
</ol>

<p>You’re all set now!  Chaos Monkey will perform a cron job once a day in which it generates the daily termination schedule by calling <code class="highlighter-rouge">chaosmonkey schedule</code>.  Once the cron job executes the <code class="highlighter-rouge">chaosmonkey terminate</code> command will be called, terminating the selected instance based on Chaos Monkey/Spinnaker/Kubernetes configuration!</p>


        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-08-30T00:00:00-07:00">August 30, 2018</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Taking+Chaos+Monkey+to+the+Next+Level+-+Advanced+Developer+Guide%20http%3A%2F%2Flocalhost%3A4000%2Fgremlin-chaos-monkey%2Fadvanced-tips%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fgremlin-chaos-monkey%2Fadvanced-tips%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Fgremlin-chaos-monkey%2Fadvanced-tips%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fgremlin-chaos-monkey%2Fadvanced-tips%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
    
    
    
    
    
    <li><a href="/gremlin-chaos-monkey/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Gabe Wyatt. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/gremlin-chaos-monkey/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>








  </body>
</html>