<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.13.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Taking Chaos Monkey to the Next Level - Advanced Developer Guide - Gremlin: Chaos Monkey</title>
<meta name="description" content="A detailed, advanced developer guide for Chaos Monkey and related alternatives/technologies.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Gremlin: Chaos Monkey">
<meta property="og:title" content="Taking Chaos Monkey to the Next Level - Advanced Developer Guide">
<meta property="og:url" content="http://localhost:4000/gremlin-chaos-monkey/advanced-tips/">








  <meta property="article:published_time" content="2018-09-12T00:00:00-07:00">





  

  


<link rel="canonical" href="http://localhost:4000/gremlin-chaos-monkey/advanced-tips/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Gabe Wyatt",
      "url": "http://localhost:4000/gremlin-chaos-monkey",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/gremlin-chaos-monkey/feed.xml" type="application/atom+xml" rel="alternate" title="Gremlin: Chaos Monkey Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/gremlin-chaos-monkey/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->
<link rel="icon" href="https://www.gremlin.com/favicon-32x32.png" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/gremlin-chaos-monkey/">Gremlin: Chaos Monkey</a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/gremlin-chaos-monkey/notes">Notes to Editor</a>
            </li>
<li class="masthead__menu-item">
              <a href="https://drive.google.com/drive/folders/16PhHEJGZtF428eyko_6-2BxpDGAU9JhW?usp=sharing" target="_blank" rel="noopener noreferrer">Google Drive Exports</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="http://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="http://localhost:4000/gremlin-chaos-monkey/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Taking Chaos Monkey to the Next Level - Advanced Developer Guide</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox">
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Hub Pages</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/" class="">Chaos Monkey Guide for Engineers</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/origin-netflix" class="">The Origin of Chaos Monkey</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/developer-tutorial" class="">Chaos Monkey Tutorial</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/advanced-tips" class="">Advanced Developer Guide</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/simian-army" class="">The Simian Army</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/downloads-resources" class="">Chaos Monkey Resources</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives" class="">Chaos Monkey Alternatives</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Alternatives</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/azure" class="">Azure</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/docker" class="">Docker</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/google-cloud-platform" class="">Google Cloud Platform</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/kubernetes" class="">Kubernetes</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/openshift" class="">OpenShift</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/private-cloud" class="">Private Cloud</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/spring-boot" class="">Spring Boot</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/vmware" class="">VMware</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Taking Chaos Monkey to the Next Level - Advanced Developer Guide">
    
    <meta itemprop="datePublished" content="September 12, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Taking Chaos Monkey to the Next Level - Advanced Developer Guide
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  25 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> </h4></header>
              <ul class="toc__menu">
  <li><a href="#how-to-install-aws-cli">How to Install AWS CLI</a></li>
  <li><a href="#how-to-install-halyard">How to Install Halyard</a></li>
  <li>
<a href="#how-to-manually-deploy-spinnaker-for-chaos-monkey">How to Manually Deploy Spinnaker for Chaos Monkey</a>
    <ul>
      <li>
<a href="#deploying-a-spinnaker-stack-with-aws-console">Deploying a Spinnaker Stack with AWS Console</a>
        <ul>
          <li><a href="#prerequisites">Prerequisites</a></li>
          <li><a href="#next-steps">Next Steps</a></li>
        </ul>
      </li>
      <li>
<a href="#deploying-a-spinnaker-stack-with-aws-cli">Deploying a Spinnaker Stack with AWS CLI</a>
        <ul>
          <li><a href="#prerequisites-1">Prerequisites</a></li>
          <li><a href="#next-steps-1">Next Steps</a></li>
        </ul>
      </li>
      <li>
<a href="#deploying-a-spinnaker-stack-with-kubernetes">Deploying a Spinnaker Stack with Kubernetes</a>
        <ul>
          <li><a href="#prerequisites-2">Prerequisites</a></li>
          <li><a href="#next-steps-2">Next Steps</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<a href="#how-to-install-spinnaker">How to Install Spinnaker</a>
    <ul>
      <li><a href="#next-steps-3">Next Steps</a></li>
    </ul>
  </li>
  <li>
<a href="#how-to-deploy-spinnaker-on-kubernetes">How to Deploy Spinnaker on Kubernetes</a>
    <ul>
      <li><a href="#prerequisites-3">Prerequisites</a></li>
      <li><a href="#install-kubectl">Install Kubectl</a></li>
      <li><a href="#install-aws-iam-authenticator">Install AWS IAM Authenticator</a></li>
      <li>
<a href="#configure-kubectl">Configure Kubectl</a>
        <ul>
          <li><a href="#prerequisites-4">Prerequisites</a></li>
        </ul>
      </li>
      <li><a href="#create-aws-accounts-and-roles">Create AWS Accounts and Roles</a></li>
      <li><a href="#add-kubernetes-provider-to-halyard">Add Kubernetes Provider to Halyard</a></li>
      <li><a href="#add-aws-provider-to-halyard">Add AWS Provider to Halyard</a></li>
      <li><a href="#add-ecs-provider-to-halyard">Add ECS Provider to Halyard</a></li>
      <li><a href="#use-distributed-deployment">Use Distributed Deployment</a></li>
      <li><a href="#use-s3-for-persistent-storage">Use S3 for Persistent Storage</a></li>
      <li><a href="#create-kubernetes-worker-nodes">Create Kubernetes Worker Nodes</a></li>
      <li><a href="#deploy-spinnaker">Deploy Spinnaker</a></li>
      <li><a href="#next-steps-4">Next Steps</a></li>
    </ul>
  </li>
</ul>
            </nav>
          </aside>
        
        <p>This chapter provides advanced developer tips for Chaos Monkey and other Chaos Engineering tools, including tutorials for manually deploying Spinnaker stacks on a <a href="/gremlin-chaos-monkey/advanced-tips#how-to-manually-deploy-spinnaker-for-chaos-monkey">local machine</a>, <a href="/gremlin-chaos-monkey/advanced-tips#how-to-manually-deploy-spinnaker-for-chaos-monkey">virtual machine</a>, or <a href="/gremlin-chaos-monkey/advanced-tips#deploying-a-spinnaker-stack-with-kubernetes">with Kubernetes</a>.  From there you can configure and <a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-spinnaker">deploy Spinnaker</a> itself, along with <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-install-chaos-monkey">Chaos Monkey</a> and <a href="/gremlin-chaos-monkey/alternatives">other Chaos Engineering tools</a>!</p>

<h2 id="how-to-install-aws-cli">How to Install AWS CLI</h2>

<p>Start by installing the <a href="https://docs.aws.amazon.com/cli/latest/userguide/installing.html" target="_blank" rel="noopener noreferrer">AWS CLI tool</a> on your machine, if necessary.</p>

<div class="premonition info modified">
<div class="fa fa-info-circle"></div>
<div class="content">
<p class="header">Simplifying AWS Credentials</p>
<p>You can make future AWS CLI commands easier by creating AWS <code class="highlighter-rouge">profiles</code>, which will add configuration and credentials to the local <code class="highlighter-rouge">~/.aws/credentials</code> file.  In some cases you’ll be using two different accounts/profiles, so you can add the credentials for multiple accounts to <code class="highlighter-rouge">~/.aws/credentials</code> by using <code class="highlighter-rouge">aws configure --profile &lt;profile-name&gt;</code> commands.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws configure <span class="nt">--profile</span> spinnaker-developer
AWS Access Key ID <span class="o">[</span>None]: &lt;AWS_ACCESS_KEY_ID&gt;
AWS Secret Access Key <span class="o">[</span>None]: &lt;AWS_SECRET_ACCESS_KEY&gt;
Default region name <span class="o">[</span>None]: us-west-2
Default output format <span class="o">[</span>None]: text
   
aws configure <span class="nt">--profile</span> primary
AWS Access Key ID <span class="o">[</span>None]: &lt;AWS_ACCESS_KEY_ID&gt;
AWS Secret Access Key <span class="o">[</span>None]: &lt;AWS_SECRET_ACCESS_KEY&gt;
Default region name <span class="o">[</span>None]: us-west-2
Default output format <span class="o">[</span>None]: text
</code></pre></div></div>

<p>In the future, simply add the <code class="highlighter-rouge">--profile &lt;profile-name&gt;</code> flag to any AWS CLI command to force AWS CLI to use that account.</p>
</div>
</div>

<h2 id="how-to-install-halyard">How to Install Halyard</h2>

<p><a href="https://www.spinnaker.io/setup/install/halyard/" target="_blank" rel="noopener noreferrer">Halyard</a> is the CLI tool that manages Spinnaker deployments and is typically the first step to any manual Spinnaker setup.</p>

<ol>
  <li>Download Halyard installation script.
    <ul>
      <li>For Debian/Ubuntu.
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  curl <span class="nt">-O</span> https://raw.githubusercontent.com/spinnaker/halyard/master/install/debian/InstallHalyard.sh
</code></pre></div>        </div>
      </li>
      <li>For MacOS.
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  curl <span class="nt">-O</span> https://raw.githubusercontent.com/spinnaker/halyard/master/install/macos/InstallHalyard.sh
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Install Halyard with the <code class="highlighter-rouge">InstallHalyard.sh</code> script.  If prompted, default options are usually just fine.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>bash InstallHalyard.sh
</code></pre></div>    </div>
  </li>
  <li>Source your recently-modified <code class="highlighter-rouge">.bashrc</code> file (or <code class="highlighter-rouge">~/.bash_profile</code>).
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">.</span> ~/.bashrc
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify Halyard was installed by checking the version.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal <span class="nt">-v</span>
 <span class="c"># OUTPUT</span>
 1.9.1-20180830145737
</code></pre></div>    </div>
  </li>
  <li>That’s the basics!  Halyard is now ready to be configured and used for <a href="/gremlin-chaos-monkey/advanced-tips#how-to-manually-deploy-spinnaker-for-chaos-monkey">manual</a> or <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-quickly-deploy-spinnaker-for-chaos-monkey">quick start</a> Spinnaker deployments.</li>
</ol>

<h2 id="how-to-manually-deploy-spinnaker-for-chaos-monkey">How to Manually Deploy Spinnaker for Chaos Monkey</h2>

<p>Manually deploying Spinnaker with the help of Halyard is the best way to have the utmost control over your Spinnaker installation, and is ideal for advanced deployments to EC2 instances, EKS/Kubernetes clusters, and the like.  Choose one of the three options depending on your needs.</p>

<ul>
  <li><a href="/gremlin-chaos-monkey/advanced-tips#deploying-a-spinnaker-stack-with-aws-console">Deploying a Spinnaker Stack with AWS Console</a></li>
  <li><a href="/gremlin-chaos-monkey/advanced-tips#deploying-a-spinnaker-stack-with-aws-cli">Deploying a Spinnaker Stack with AWS CLI</a></li>
  <li><a href="/gremlin-chaos-monkey/advanced-tips#deploying-a-spinnaker-stack-with-kubernetes">Deploying a Spinnaker Stack with Kubernetes</a></li>
</ul>

<p>After Spinnaker is running on your chosen platform proceed to our <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-install-chaos-monkey">How to Install Chaos Monkey</a> guide to get started with Chaos Monkey!</p>

<h3 id="deploying-a-spinnaker-stack-with-aws-console">Deploying a Spinnaker Stack with AWS Console</h3>

<p>This section will guide you through deploying a Spinnaker stack with the AWS web console.</p>

<h4 id="prerequisites">Prerequisites</h4>

<ul>
  <li><strong><a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-halyard">Install Halyard</a></strong></li>
</ul>

<ol>
  <li>In AWS navigate to <strong>CloudFormation</strong> and click <strong>Create Stack</strong>.</li>
  <li>Download <a href="https://d3079gxvs8ayeg.cloudfront.net/templates/managing.yaml" target="_blank" rel="noopener noreferrer">this</a> <code class="highlighter-rouge">managing.yaml</code> file to your local machine.</li>
  <li>Under <strong>Choose a template</strong> click the <strong>Choose File</strong> button under <strong>Upload a template to Amazon S3</strong> and select the downloaded <code class="highlighter-rouge">managing.yaml</code>.</li>
  <li>Click <strong>Next</strong>.</li>
  <li>Input <code class="highlighter-rouge">spinnaker-managing-infrastructure-setup</code> into the <strong>Stack name</strong> field.</li>
  <li>Select <code class="highlighter-rouge">false</code> in the <strong>UseAccessKeyForAuthentication</strong> dropdown.</li>
  <li>Click <strong>Next</strong>.</li>
  <li>On the <strong>Options</strong> screen leave defaults and click <strong>Next</strong>.</li>
  <li>
    <p>Check the <strong>I acknowledge that AWS CloudFormation might create IAM resources with custom names.</strong> checkbox and click <strong>Create</strong> to generate the stack.</p>

    <div class="premonition note modified">
<div class="fa fa-check-square"></div>
<div class="content">
<p class="header">Note</p>
<p>If your AWS account already contains the <code class="highlighter-rouge">BaseIAMRole</code> AWS::IAM::ROLE you may have to delete it before this template will succeed.</p>
</div>
</div>
  </li>
  <li>
    <p>Once the <code class="highlighter-rouge">spinnaker-managing-infrastructure-setup</code> stack has a <code class="highlighter-rouge">CREATE_COMPLETE</code> <strong>Status</strong>, select the <strong>Outputs</strong> tab and copy all <code class="highlighter-rouge">key/value</code> pairs there somewhere convenient.  They’ll look something like the following.</p>

    <table>
      <thead>
        <tr>
          <th>Key</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>VpcId</td>
          <td>vpc-0eff1ddd5f7b26ffc</td>
        </tr>
        <tr>
          <td>ManagingAccountId</td>
          <td>123456789012</td>
        </tr>
        <tr>
          <td>AuthArn</td>
          <td>arn:aws:iam::123456789012:role/SpinnakerAuthRole</td>
        </tr>
        <tr>
          <td>SpinnakerInstanceProfileArn</td>
          <td>arn:aws:iam::123456789012:instance-profile/spinnaker-managing-infrastructure-setup-SpinnakerInstanceProfile-1M72QQCCLNCZ9</td>
        </tr>
        <tr>
          <td>SubnetIds</td>
          <td>subnet-0c5fb1e7ab00f20a7,subnet-065af1a1830937f86</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>Add a new AWS account to Halyard named <code class="highlighter-rouge">spinnaker-developer</code> with your AWS account id and your appropriate AWS region name.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>hal config provider aws account add spinnaker-developer <span class="se">\</span>
<span class="nt">--account-id</span> 123456789012 <span class="se">\</span>
<span class="nt">--assume-role</span> role/spinnakerManaged <span class="se">\</span>
<span class="nt">--regions</span> us-west-2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Enable AWS in Halyard.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>hal config provider aws <span class="nb">enable</span>
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="next-steps">Next Steps</h4>

<p>You’re now ready to <a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-spinnaker">install Spinnaker</a> and <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-install-chaos-monkey">install Chaos Monkey</a> to begin Chaos Experimentation!</p>

<h3 id="deploying-a-spinnaker-stack-with-aws-cli">Deploying a Spinnaker Stack with AWS CLI</h3>

<p>This section will guide you through deploying a Spinnaker stack with the AWS CLI tool.</p>

<h4 id="prerequisites-1">Prerequisites</h4>

<ul>
  <li><strong><a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-halyard">Install Halyard</a></strong></li>
  <li><strong><a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-aws-cli">Install AWS CLI</a></strong></li>
</ul>

<ol>
  <li>
    <p>Download <a href="https://d3079gxvs8ayeg.cloudfront.net/templates/managing.yaml" target="_blank" rel="noopener noreferrer">this</a> <code class="highlighter-rouge">managing.yaml</code> template.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-OL</span> https://d3079gxvs8ayeg.cloudfront.net/templates/managing.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now we’ll use AWS CLI to create the <code class="highlighter-rouge">spinnaker-managing-infrastructure</code> stack via CloudFormation.  We want to use the <code class="highlighter-rouge">primary</code> or managing account for this, so we’ll specify the <code class="highlighter-rouge">--profile primary</code>, which will grab the appropriate credentials, region, and so forth.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> aws cloudformation deploy <span class="nt">--stack-name</span> spinnaker-managing-infrastructure <span class="nt">--template-file</span> managing.yaml <span class="nt">--parameter-overrides</span> <span class="nv">UseAccessKeyForAuthentication</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM <span class="nt">--profile</span> primary
</code></pre></div>    </div>
  </li>
</ol>

<div class="premonition error modified">
<div class="fa fa-exclamation-triangle"></div>
<div class="content">
<p class="header">Error: Unresolved resource dependency for `SpinnakerInstanceProfile`.</p>
<p>If you receive the above error while creating the <code class="highlighter-rouge">spinnaker-managing-infrastructure</code> stack you may need to edit the <code class="highlighter-rouge">managing.yaml</code> file and comment out the two <code class="highlighter-rouge">SpinnakerInstanceProfileArn</code> related lines under the <code class="highlighter-rouge">Outputs</code> block.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...</span>
Outputs:
<span class="c"># ...</span>
<span class="c">#  SpinnakerInstanceProfileArn:</span>
<span class="c">#    Value: !GetAtt SpinnakerInstanceProfile.Arn</span>
</code></pre></div></div>
</div>
</div>

<ol>
  <li>
    <p>Once the <code class="highlighter-rouge">spinnaker-managing-infrastructure</code> stack has been created open the AWS console, navigate to the <code class="highlighter-rouge">CloudFormation</code> service, select the <strong>Outputs</strong> tab of the <code class="highlighter-rouge">spinnaker-managing-infrastructure</code> stack.  We’ll be using the <code class="highlighter-rouge">ManagingAccountId</code> and <code class="highlighter-rouge">AuthArn</code> values in the next step, which look something like the following.</p>

    <table>
      <thead>
        <tr>
          <th>Key</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>ManagingAccountId</td>
          <td>123456789012</td>
        </tr>
        <tr>
          <td>AuthArn</td>
          <td>arn:aws:iam::123456789012:user/spinnaker-managing-infrastructure-SpinnakerUser-15UU17KIS3EK1</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>Download <a href="https://d3079gxvs8ayeg.cloudfront.net/templates/managed.yaml" target="_blank" rel="noopener noreferrer">this</a> <code class="highlighter-rouge">managed.yaml</code> template.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-OL</span> https://d3079gxvs8ayeg.cloudfront.net/templates/managed.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now enter the following command to create the companion <code class="highlighter-rouge">spinnaker-managed-infrastructure</code> stack in CloudFormation.  Be sure to specify the <strong>profile</strong> value and paste the appropriate <code class="highlighter-rouge">ManagingAccountId</code> and <code class="highlighter-rouge">AuthArn</code> values from above.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> aws cloudformation deploy <span class="nt">--stack-name</span> spinnaker-managed-infrastructure <span class="nt">--template-file</span> managed.yaml <span class="se">\</span>
 <span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM <span class="nt">--profile</span> spinnaker-developer <span class="nt">--parameter-overrides</span> <span class="se">\</span>
 <span class="nv">AuthArn</span><span class="o">=</span>&lt;ManagingStack_AuthArnValue&gt; <span class="se">\</span>
 <span class="nv">ManagingAccountId</span><span class="o">=</span>&lt;ManagingStack_ManagingAccountId&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add your AWS Access Id and Secret Keys to Halyard.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config provider aws edit <span class="nt">--access-key-id</span> &lt;AWS_ACCESS_KEY_ID&gt; <span class="nt">--secret-access-key</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add your default managing account to Spinnaker.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config provider aws account add default <span class="nt">--account-id</span> 123456789012 <span class="nt">--assume-role</span> role/spinnakerManaged <span class="nt">--regions</span> us-west-2
</code></pre></div>    </div>

    <div class="premonition info modified">
<div class="fa fa-info-circle"></div>
<div class="content"><p>Spinnaker uses <code class="highlighter-rouge">accounts</code> added via the Halyard <code class="highlighter-rouge">hal config provider aws account</code> API to handle all actions performed within the specified provider (such as AWS, in this case).  For this example we’ll just be using our primary managing account, but you can freely add more accounts as needed.</p></div>
</div>
  </li>
  <li>
    <p>Enable the AWS provider.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config provider aws <span class="nb">enable</span>
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="next-steps-1">Next Steps</h4>

<p>With Spinnaker configured it’s now time to <a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-spinnaker">install Spinnaker</a> and then <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-install-chaos-monkey">install Chaos Monkey</a>.</p>

<h3 id="deploying-a-spinnaker-stack-with-kubernetes">Deploying a Spinnaker Stack with Kubernetes</h3>

<p>Follow these steps to setup a CloudFormation EKS/Kubernetes stack for Spinnaker and Chaos Monkey.</p>

<h4 id="prerequisites-2">Prerequisites</h4>

<ul>
  <li><strong><a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-halyard">Install Halyard</a></strong></li>
  <li><strong><a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-aws-cli">Install AWS CLI</a></strong></li>
</ul>

<ol>
  <li>
    <p>Download <a href="https://d3079gxvs8ayeg.cloudfront.net/templates/managing.yaml" target="_blank" rel="noopener noreferrer">this</a> <code class="highlighter-rouge">managing.yaml</code> template.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://d3079gxvs8ayeg.cloudfront.net/templates/managing.yaml
</code></pre></div>    </div>

    <div class="premonition info modified">
<div class="fa fa-info-circle"></div>
<div class="content">
<p class="header">Stack Configuration</p>
<p>If you need to configure the stack to your own particular needs you can easily edit the template YAML as necessary.  For example, in this guide we’re only using a single <strong>managing</strong> account to handle Spinnaker/Kubernetes in AWS, but if you need to also include additional <strong>managed</strong> accounts you’ll want to add their respective AWS ARN strings to the <code class="highlighter-rouge">managing.yaml</code> file <a href="https://gist.github.com/GabeStah/524fdb512e65e354076d71e53d9994eb#file-managing-yaml-L158" target="_blank" rel="noopener noreferrer">around this line</a>.</p>
</div>
</div>
  </li>
  <li>
    <p>Now we’ll use AWS CLI to issue a <code class="highlighter-rouge">cloudformation deploy</code> command to create a new <code class="highlighter-rouge">spinnaker-managing-infrastructure-setup</code> stack using the <code class="highlighter-rouge">managing.yaml</code> template.  From here on out this guide will use explicit names where applicable, but feel free to customize options as you see fit (such as the <strong>stack name</strong>, <strong>EksClusterName</strong>, and so forth).</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> aws cloudformation deploy <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--template-file</span> managing.yaml <span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM <span class="se">\</span>
 <span class="nt">--parameter-overrides</span> <span class="nv">UseAccessKeyForAuthentication</span><span class="o">=</span><span class="nb">false </span><span class="nv">EksClusterName</span><span class="o">=</span>spinnaker-cluster
</code></pre></div>    </div>
  </li>
  <li>
    <p>The step above takes 10 - 15 minutes to complete, but once complete issue the following commands, which will use the AWS CLI to assign some environment variables values from the <code class="highlighter-rouge">spinnaker-managing-infrastructure-setup</code> stack we just created.  We’ll be using these values throughout the remainder of this guide.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nv">VPC_ID</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`VpcId`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">CONTROL_PLANE_SG</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`SecurityGroups`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">AUTH_ARN</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`AuthArn`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">SUBNETS</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`SubnetIds`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">MANAGING_ACCOUNT_ID</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`ManagingAccountId`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">EKS_CLUSTER_ENDPOINT</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`EksClusterEndpoint`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">EKS_CLUSTER_NAME</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`EksClusterName`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">EKS_CLUSTER_CA_DATA</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`EksClusterCA`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
 <span class="nv">SPINNAKER_INSTANCE_PROFILE_ARN</span><span class="o">=</span><span class="k">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> spinnaker-managing-infrastructure-setup <span class="nt">--query</span> <span class="s1">'Stacks[0].Outputs[?OutputKey==`SpinnakerInstanceProfileArn`].OutputValue'</span> <span class="nt">--output</span> text<span class="k">)</span>
</code></pre></div>    </div>

    <div class="premonition info modified">
<div class="fa fa-info-circle"></div>
<div class="content"><p>You can easily output the value of an exported variable with <code class="highlighter-rouge">echo $VARIABLE_NAME</code>.  However, remember that unless you <code class="highlighter-rouge">export</code> these values they only temporarily exist in the console in which you issued the commands.  You may need to reissue the above commands later in the guide if you change terminal windows, so keep them handy.</p></div>
</div>
  </li>
  <li>
    <p>Download <a href="https://d3079gxvs8ayeg.cloudfront.net/templates/managed.yaml" target="_blank" rel="noopener noreferrer">this</a> <code class="highlighter-rouge">managed.yaml</code> template.  This template will create the <code class="highlighter-rouge">spinnakerManaged</code> <strong>AWS::IAM::Role</strong> that Spinnaker can use.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://d3079gxvs8ayeg.cloudfront.net/templates/managed.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Execute this secondary CloudFormation deployment using the <code class="highlighter-rouge">managed.yaml</code>.  Notice that this command (and many following commands) use some of the environmental variables we assigned previously, so the first stack deployment will need to be complete first.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> aws cloudformation deploy <span class="nt">--stack-name</span> spinnaker-managed-infrastructure-setup <span class="nt">--template-file</span> managed.yaml <span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM <span class="se">\</span>
 <span class="nt">--parameter-overrides</span> <span class="nv">AuthArn</span><span class="o">=</span><span class="nv">$AUTH_ARN</span> <span class="nv">ManagingAccountId</span><span class="o">=</span><span class="nv">$MANAGING_ACCOUNT_ID</span>
</code></pre></div>    </div>

    <div class="premonition info modified">
<div class="fa fa-info-circle"></div>
<div class="content"><p>If the second step of deploying <code class="highlighter-rouge">spinnaker-managing-infrastructure-setup</code> hasn’t completed yet, feel free to skip this step for the time being and proceed with installing <code class="highlighter-rouge">kubectl</code> and <code class="highlighter-rouge">AWS IAM Authenticator</code> below.  Just return to this step before moving past that point.</p></div>
</div>
  </li>
</ol>

<h4 id="next-steps-2">Next Steps</h4>

<p>You now have an EKS/Kubernetes CloudFormation stack ready for Spinnaker.  You can now proceed with the <a href="/gremlin-chaos-monkey/advanced-tips#how-to-deploy-spinnaker-on-kubernetes">deployment of Spinnaker on Kubernetes</a>, and then move on to <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-install-chaos-monkey">installing and using Chaos Monkey</a>.  If Chaos Monkey doesn’t suit all your Chaos Engineering needs check out our <a href="/gremlin-chaos-monkey/alternatives">Chaos Monkey Alternatives</a> chapter.</p>

<h2 id="how-to-install-spinnaker">How to Install Spinnaker</h2>

<p>This section walks you through the most basic Spinnaker installation process, suitable for simple Spinnaker deployments.</p>

<ol>
  <li>
    <p>Use the <code class="highlighter-rouge">hal version list</code> command to view the current Spinnaker version list.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal version list
</code></pre></div>    </div>
  </li>
  <li>
    <p>Configure Halyard to use the latest version of Spinnaker.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config version edit <span class="nt">--version</span> 1.9.2
</code></pre></div>    </div>
  </li>
  <li>
    <p><em>(Optional)</em> Enable Chaos Monkey in the Halyard config.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config features edit <span class="nt">--chaos</span> <span class="nb">true</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Tell Halyard what type of environment you’re deploying Spinnaker to.  Most production setups will want to use Kubernetes or another distributed solution, but the default deployment is a local installation.  The <code class="highlighter-rouge">hal config deploy edit --type</code> flag can be used to change the environment.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config deploy edit <span class="nt">--type</span> localdebian
</code></pre></div>    </div>
  </li>
  <li>
    <p>Halyard requires some form of persistent storage, so we’ll use AWS S3 for simplicity.  Modify the Halyard config and be sure to pass an AWS <code class="highlighter-rouge">ACCESS_KEY_ID</code> and <code class="highlighter-rouge">SECRET_ACCESS_KEY</code> with privileges to create and use S3 buckets.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config storage s3 edit <span class="nt">--access-key-id</span> &lt;AWS_ACCESS_KEY_ID&gt; <span class="nt">--secret-access-key</span> <span class="nt">--region</span> us-west-2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Configure Halyard to use the <code class="highlighter-rouge">s3</code> storage type.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config storage edit <span class="nt">--type</span> s3
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now use <code class="highlighter-rouge">sudo hal deploy apply</code> to deploy Spinnaker to the local machine.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>hal deploy apply
</code></pre></div>    </div>
  </li>
  <li>
    <p>After deployment finishes you should have a functioning Spinnaker installation!  If you’ve installed on your local machine you can navigate to the Spinnaker Deck UI at <a href="http://localhost:9000">localhost:9000</a> to see it in action.  If Spinnaker was deployed on a remote machine use the <code class="highlighter-rouge">hal deploy connect</code> command to quickly establish SSH tunnels and connect.</p>
  </li>
</ol>

<h3 id="next-steps-3">Next Steps</h3>

<p>You’re now ready to <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-install-chaos-monkey">install</a> and then start <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-use-chaos-monkey">using Chaos Monkey</a> or other <a href="/gremlin-chaos-monkey/simian-army">Simian Army</a> tools.</p>

<h2 id="how-to-deploy-spinnaker-on-kubernetes">How to Deploy Spinnaker on Kubernetes</h2>

<p>This guide will walk you through the entire process of setting up a Kubernetes cluster via AWS EKS, attaching some worker nodes (i.e. EC2 instances), deploying Spinnaker to manage the Kubernetes cluster, and then using Chaos Monkey and other Simian Army tools on it!  If you’re looking for a simpler Spinnaker installation, you might be interested in our <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-quickly-deploy-spinnaker-for-chaos-monkey">Spinnaker AWS Quick Start</a> guide.</p>

<h3 id="prerequisites-3">Prerequisites</h3>

<ul>
  <li><strong><a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-halyard">Install Halyard</a></strong></li>
  <li><strong><a href="/gremlin-chaos-monkey/advanced-tips#how-to-install-aws-cli">Install AWS CLI</a></strong></li>
  <li><strong><a href="/gremlin-chaos-monkey/advanced-tips#deploying-a-spinnaker-stack-with-kubernetes">Deploy a Spinnaker Stack for Kubernetes</a></strong></li>
</ul>

<h3 id="install-kubectl">Install Kubectl</h3>

<p>We’ll need to install the <code class="highlighter-rouge">kubectl</code> client and the <code class="highlighter-rouge">AWS IAM Authenticator for Kubernetes</code>, which will allow Amazon EKS to use IAM for authentication to our Kubernetes cluster.</p>

<ol>
  <li>
    <p>Download the appropriate <code class="highlighter-rouge">kubectl</code> binary.  <em>Note: For the remainder of this guide we’ll be using Linux examples, but most everything applies to other environments.</em></p>

    <ul>
      <li>Linux: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/kubectl</li>
      <li>MacOS: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/kubectl</li>
      <li>Windows: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/kubectl.exe</li>
    </ul>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/kubectl
</code></pre></div>    </div>
  </li>
  <li>
    <p>Change permissions of <code class="highlighter-rouge">kubectl</code> so it’s executable.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> chmod +x ./kubectl
</code></pre></div>    </div>
  </li>
  <li>
    <p>Move <code class="highlighter-rouge">kubectl</code> to an appropriate <code class="highlighter-rouge">bin</code> directory and add to your <code class="highlighter-rouge">PATH</code>, if necessary.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> cp ./kubectl <span class="nv">$HOME</span>/bin/kubectl <span class="o">&amp;&amp;</span> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/bin:<span class="nv">$PATH</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify that <code class="highlighter-rouge">kubectl</code> is installed.  The <code class="highlighter-rouge">--client</code> flag is used here since we’re just checking for the local installation, not making any connections yet.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> kubectl version <span class="nt">--client</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="install-aws-iam-authenticator">Install AWS IAM Authenticator</h3>

<p>We’ll follow the same basic steps as above to install the AWS IAM Authenticator as well.</p>

<ol>
  <li>
    <p>Download the appropriate <code class="highlighter-rouge">aws-iam-authenticator</code> binary.</p>

    <ul>
      <li>Linux: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator</li>
      <li>MacOS: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator</li>
      <li>Windows: https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/aws-iam-authenticator.exe</li>
    </ul>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator
</code></pre></div>    </div>
  </li>
  <li>
    <p>Make <code class="highlighter-rouge">aws-iam-authenticator</code> executable.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> chmod +x ./aws-iam-authenticator
</code></pre></div>    </div>
  </li>
  <li>
    <p>Move <code class="highlighter-rouge">aws352-iam-authenticator</code> to an appropriate <code class="highlighter-rouge">bin</code> directory and add to your <code class="highlighter-rouge">PATH</code>, if necessary.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> cp ./aws-iam-authenticator <span class="nv">$HOME</span>/bin/aws-iam-authenticator <span class="o">&amp;&amp;</span> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/bin:<span class="nv">$PATH</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Test the <code class="highlighter-rouge">aws-iam-authenticator</code> installation.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> aws-iam-authenticator <span class="nb">help</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="configure-kubectl">Configure Kubectl</h3>

<h4 id="prerequisites-4">Prerequisites</h4>

<ul>
  <li>Make sure you’ve gone through the <a href="/gremlin-chaos-monkey/advanced-tips#deploying-a-spinnaker-stack-with-kubernetes">Deploying a Spinnaker Stack with Kubernetes</a> section.</li>
</ul>

<p>With everything setup you can now edit the <code class="highlighter-rouge">kubectl</code> configuration files, which will inform <code class="highlighter-rouge">kubectl</code> how to connect to your Kubernetes/EKS cluster.</p>

<ol>
  <li>
    <p>Copy and paste the following into the <code class="highlighter-rouge">~/.kube/config</code> file.</p>

    <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
 <span class="na">clusters</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
     <span class="na">server</span><span class="pi">:</span> <span class="s">&lt;endpoint-url&gt;</span>
     <span class="na">certificate-authority-data</span><span class="pi">:</span> <span class="s">&lt;base64-encoded-ca-cert&gt;</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">kubernetes</span>
 <span class="na">contexts</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
     <span class="na">cluster</span><span class="pi">:</span> <span class="s">kubernetes</span>
     <span class="na">user</span><span class="pi">:</span> <span class="s">aws</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
 <span class="na">current-context</span><span class="pi">:</span> <span class="s">aws</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
 <span class="na">preferences</span><span class="pi">:</span> <span class="pi">{}</span>
 <span class="na">users</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
   <span class="na">user</span><span class="pi">:</span>
     <span class="na">exec</span><span class="pi">:</span>
       <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">client.authentication.k8s.io/v1alpha1</span>
       <span class="na">command</span><span class="pi">:</span> <span class="s">aws-iam-authenticator</span>
       <span class="na">args</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">token"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">-i"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">&lt;cluster-name&gt;"</span>
         <span class="c1"># - "-r"</span>
         <span class="c1"># - "&lt;role-arn&gt;"</span>
       <span class="c1"># env:</span>
         <span class="c1"># - name: AWS_PROFILE</span>
         <span class="c1">#   value: "&lt;aws-profile&gt;"</span>
</code></pre></div>    </div>

    <div class="premonition info modified">
<div class="fa fa-info-circle"></div>
<div class="content">
<p class="header">Configuring Multiple Kubernetes Clusters</p>
<p>This guide assumes you’re just configuring <code class="highlighter-rouge">kubectl</code> to handle a single Kubernetes cluster, but if you need to configure and handle multiple clusters the convention for doing so is to create a unique <code class="highlighter-rouge">config</code> file for each cluster.  Simply name each <code class="highlighter-rouge">config</code> file <code class="highlighter-rouge">~/.kube/config-&lt;cluster-name&gt;</code>, where <code class="highlighter-rouge">&lt;cluster-name&gt;</code> is replaced by the name of the Kubernetes cluster you already created.</p>
</div>
</div>
  </li>
  <li>
    <p>Replace the <code class="highlighter-rouge">&lt;...&gt;</code> placeholder strings with the following <code class="highlighter-rouge">EKS_CLUSTER_</code> environmental variable values from earlier:</p>

    <ul>
      <li>
<code class="highlighter-rouge">&lt;endpoint-url&gt;</code>: <code class="highlighter-rouge">$EKS_CLUSTER_ENDPOINT</code>
</li>
      <li>
<code class="highlighter-rouge">&lt;base64-encoded-ca-cert&gt;</code>: <code class="highlighter-rouge">$EKS_CLUSTER_CA_DATA</code>
</li>
      <li>
<code class="highlighter-rouge">&lt;cluster-name&gt;</code>: <code class="highlighter-rouge">$EKS_CLUSTER_NAME</code>
</li>
    </ul>

    <div class="premonition info modified">
<div class="fa fa-info-circle"></div>
<div class="content">
<p class="header">Using a Specific `AWS::IAM::Role`</p>
<p>If you need to have the AWS IAM Authenticator and kubectl use a specific <code class="highlighter-rouge">Role</code> then uncomment the <code class="highlighter-rouge">- "-r"</code> and <code class="highlighter-rouge">- "&lt;role-arn&gt;"</code> lines and paste the <code class="highlighter-rouge">AWS::IAM::Role</code> ARN in place of <code class="highlighter-rouge">&lt;role-arn&gt;</code>.</p>
</div>
</div>
  </li>
  <li>
    <p>Your <code class="highlighter-rouge">~/.kube/config</code> file should now look something like this:</p>

    <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
 <span class="na">clusters</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
     <span class="na">server</span><span class="pi">:</span> <span class="s">https://51A93D4A4B1228D6D06BE160DA2D3A8A.yl4.us-west-2.eks.amazonaws.com</span>
     <span class="na">certificate-authority-data</span><span class="pi">:</span> <span class="s">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRFNE1Ea3dOakExTVRnME1BHeGFNN3QyaApzcm8wa1ZOWTdCQ1g5YVBBY09rRFVuRExGektpZTJnZVZLOFpxVHJvZEpLR0p3SEtjVDJNNUtsR0ZTSjMzSGpoCk5ZeVErTnJkd0VKT2puR2xZN3R1eVFvZjhnNU0vNWZzZSt0TWFMTjJjQ3NWNFA1NCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFKN3owTEI5NFVoZWNwTUh0VGYrVTkxVDlxU2IKNWFVRGQrdlVTNEpVTWwwdk01OXBqc05CNDU1Z1l6ZkpLelZ1YXI5TjJOVURiREllNUJsbjlCRjWb1hEVEk0TURrd016QTFNVGcwTVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBT0h6CldrZ2pzTWZ0eEJYd3NZOGRuVXI5UUQTAzZXczazlaZHZlMWNYRlp4bHdqc3RSdWN3eUxRTG12eUh0VzJsTjE4RENqSXF5OGwxeUlYSENERQpXQjI3eHo4TXg3ZDJVSjIyaThjQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0V5OSTJHYjV4QU1vYjJBaWQwbEQrT2NncGdDcXQvQ3h2SlFJRGpxbjRKT1AKejh6RVkvWVVsQjBUOTVXUUFsRE9ZWnlKY3lDeWxYcFZRTnNDRWNSMFhUakRaVDFVbXMyMmk4NlozYy8xQ1IrWgpKNkNqZ3IvZkNadVVaV0VUbGt1WXhlSG5CQS91ZURJM1NsMVdnY0ZFMGFyNGxsVkVFVngyS01PZXhuM09FdHI0CjhBd1dmQWxzSUNXRWdjMjRKdzk5MG9LelNObXB0cWRaOEFwczhVaHJoZWtoNEh1blpFLzhud1prb213SE1TcTYKbjl5NFJN3RyR0xWN0RzMUxWUFBlWjkKVVB0eU1WODlieFVEeFhNV3I3d2tNRy9YckdtaC9nN1gwb1grdXRnUUtiSWdPaHZMZEFKSDNZUUlyTjhHS0krcwpIMGtjTnpYMWYzSGdabUVINUIxNXhER0R2SnA5a045Q29VdjRYVE5tdlljVlNVSy9vcWdwaXd1TU9oZz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">kubernetes</span>
 <span class="na">contexts</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
     <span class="na">cluster</span><span class="pi">:</span> <span class="s">kubernetes</span>
     <span class="na">user</span><span class="pi">:</span> <span class="s">aws</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
 <span class="na">current-context</span><span class="pi">:</span> <span class="s">aws</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
 <span class="na">preferences</span><span class="pi">:</span> <span class="pi">{}</span>
 <span class="na">users</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
   <span class="na">user</span><span class="pi">:</span>
     <span class="na">exec</span><span class="pi">:</span>
       <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">client.authentication.k8s.io/v1alpha1</span>
       <span class="na">command</span><span class="pi">:</span> <span class="s">aws-iam-authenticator</span>
       <span class="na">args</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">token"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">-i"</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">spinnaker-cluster"</span>
         <span class="c1"># - "-r"</span>
         <span class="c1"># - "&lt;role-arn&gt;"</span>
       <span class="c1"># env:</span>
         <span class="c1"># - name: AWS_PROFILE</span>
         <span class="c1">#   value: "&lt;aws-profile&gt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Save your <code class="highlighter-rouge">config</code> file and export the <code class="highlighter-rouge">KUBECONFIG</code> variable to include the new <code class="highlighter-rouge">config</code> location.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$KUBECONFIG</span>:~/.kube/config
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify that <code class="highlighter-rouge">kubectl</code> is able to use your credentials to connect to your cluster with <code class="highlighter-rouge">kubectl get svc</code>:</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> kubectl get svc

 NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
 kubernetes   ClusterIP   172.25.0.1   &lt;none&gt;        443/TCP   31m
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="create-aws-accounts-and-roles">Create AWS Accounts and Roles</h3>

<p>We now need to apply service accounts and roles to the <code class="highlighter-rouge">kubectl</code> <code class="highlighter-rouge">spinnaker</code> namespace.  In Kubernetes, a <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" target="_blank" rel="noopener noreferrer">namespace</a> is a <em>virtual</em> cluster, which can join other virtual clusters and all be housed within the same <em>physical</em> cluster.</p>

<ol>
  <li>
    <p>Issue the following commands to create the <code class="highlighter-rouge">spinnaker</code> namespace, <code class="highlighter-rouge">spinnaker-service-account</code> service account, and <code class="highlighter-rouge">spinnaker-admin</code> binding.  The <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#apply" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">apply</code></a> command in <code class="highlighter-rouge">kubectl</code> applies a configuration based on the passed resource (YAML files, in this case).</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nv">CONTEXT</span><span class="o">=</span>aws
 kubectl create namespace spinnaker
 kubectl apply <span class="nt">-f</span> https://d3079gxvs8ayeg.cloudfront.net/templates/spinnaker-service-account.yaml
 kubectl apply <span class="nt">-f</span> https://d3079gxvs8ayeg.cloudfront.net/templates/spinnaker-cluster-role-binding.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Next, we’re creating the authentication <code class="highlighter-rouge">TOKEN</code> environmental variable.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>kubectl get secret <span class="nt">--context</span> <span class="nv">$CONTEXT</span> <span class="se">\</span>
   <span class="k">$(</span>kubectl get serviceaccount spinnaker-service-account <span class="se">\</span>
       <span class="nt">--context</span> <span class="nv">$CONTEXT</span> <span class="se">\</span>
       <span class="nt">-n</span> spinnaker <span class="se">\</span>
       <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.secrets[0].name}'</span><span class="k">)</span> <span class="se">\</span>
   <span class="nt">-n</span> spinnaker <span class="se">\</span>
   <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.data.token}'</span> | base64 <span class="nt">--decode</span><span class="k">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Pass the <code class="highlighter-rouge">TOKEN</code> to the following configuration commands to set <code class="highlighter-rouge">kubectl</code> credentials.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> kubectl config set-credentials <span class="k">${</span><span class="nv">CONTEXT</span><span class="k">}</span><span class="nt">-token-user</span> <span class="nt">--token</span> <span class="nv">$TOKEN</span>
 kubectl config set-context <span class="nv">$CONTEXT</span> <span class="nt">--user</span> <span class="k">${</span><span class="nv">CONTEXT</span><span class="k">}</span><span class="nt">-token-user</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="add-kubernetes-provider-to-halyard">Add Kubernetes Provider to Halyard</h3>

<p>The next step is to add Kubernetes as a provider to Halyard/Spinnaker. A <a href="https://www.spinnaker.io/concepts/providers/" target="_blank" rel="noopener noreferrer">provider</a> is just an interface to one of many virtual resources Spinnaker will utilize.  AWS, Azure, Docker, and many more are all considered providers, and are managed by Spinnaker via <code class="highlighter-rouge">accounts</code>.</p>

<ol>
  <li>
    <p>Start by enabling the Kubernetes provider in Halyard.4</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config provider kubernetes <span class="nb">enable</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add the <code class="highlighter-rouge">kubernetes-master</code> account to Halyard.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config provider kubernetes account add kubernetes-master <span class="nt">--provider-version</span> v2 <span class="nt">--context</span> <span class="k">$(</span>kubectl config current-context<span class="k">)</span><span class="sb">`</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Enable the <code class="highlighter-rouge">artifacts</code> and <code class="highlighter-rouge">chaos</code> features of Halyard.  <a href="https://www.spinnaker.io/reference/artifacts/" target="_blank" rel="noopener noreferrer">Artifacts</a> in Spinnaker merely reference any external resource, such as a remote file, a binary blob, and image, and so forth.  The <code class="highlighter-rouge">chaos</code> feature allows us to utilize Chaos Monkey, the base form of which is built into Spinnaker by default.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config features edit <span class="nt">--artifacts</span> <span class="nb">true
 </span>hal config features edit <span class="nt">--chaos</span> <span class="nb">true</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="add-aws-provider-to-halyard">Add AWS Provider to Halyard</h3>

<p>Now we need to also add AWS as another provider and account.  Be sure to replace <code class="highlighter-rouge">&lt;AWS_ACCOUNT_ID&gt;</code> with the primary/managing account ID of your AWS account.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config provider aws account add aws-primary <span class="nt">--account-id</span> &lt;AWS_ACCOUNT_ID&gt; <span class="nt">--assume-role</span> role/spinnakerManaged
hal config provider aws <span class="nb">enable</span>
</code></pre></div></div>

<h3 id="add-ecs-provider-to-halyard">Add ECS Provider to Halyard</h3>

<p>The last provider to enable is ECS.  We’ll add the <code class="highlighter-rouge">ecs-primary</code> account to Halyard and associate it with the <code class="highlighter-rouge">aws-primary</code> AWS account added above:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config provider ecs account add ecs-primary <span class="nt">--aws-account</span> aws-primary
hal config provider ecs <span class="nb">enable</span>
</code></pre></div></div>

<h3 id="use-distributed-deployment">Use Distributed Deployment</h3>

<p>We also need to ensure Halyard deploys Spinnaker in a distributed fashion among our Kubernetes cluster.  Without this step, the default configuration is to deploy Spinnaker onto the local machine.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config deploy edit <span class="nt">--type</span> distributed <span class="nt">--account-name</span> kubernetes-master
</code></pre></div></div>

<div class="premonition error modified">
<div class="fa fa-exclamation-triangle"></div>
<div class="content">
<p class="header">Error: `kubectl` not installed, or can't be found by Halyard.</p>
<p>If you get such an error when issuing the distributed deployment command above, it likely means Halyard just needs to be restarted.  Simply issue the <code class="highlighter-rouge">hal shutdown</code> command to stop the Halyard daemon, then retry the deployment edit command again, which will automatically restart Halyard before executing.</p>
</div>
</div>

<h3 id="use-s3-for-persistent-storage">Use S3 for Persistent Storage</h3>

<p>Let’s tell Spinnaker to use AWS S3 for storing persistent data (in this case, creating a small S3 bucket).  Issue the following command by replacing <code class="highlighter-rouge">&lt;AWS_ACCESS_KEY_ID&gt;</code> with any AWS access key that has full S3 service privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config storage s3 edit <span class="nt">--access-key-id</span> &lt;AWS_ACCESS_KEY_ID&gt; <span class="nt">--secret-access-key</span> <span class="nt">--region</span> us-west-2
hal config storage edit <span class="nt">--type</span> s3
</code></pre></div></div>

<h3 id="create-kubernetes-worker-nodes">Create Kubernetes Worker Nodes</h3>

<p>Now we’ll launch some AWS EC2 instances which will be our worker nodes for our Kubernetes cluster to manage.</p>

<ol>
  <li>
    <p>Download <a href="https://d3079gxvs8ayeg.cloudfront.net/templates/amazon-eks-nodegroup.yaml" target="_blank" rel="noopener noreferrer">this</a> <code class="highlighter-rouge">amazon-eks-nodegroup.yml</code> template file.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://d3079gxvs8ayeg.cloudfront.net/templates/amazon-eks-nodegroup.yaml
</code></pre></div>    </div>

    <div class="premonition info modified">
<div class="fa fa-info-circle"></div>
<div class="content">
<p class="header">Adjust Worker Nodes</p>
<p>The default template creates an auto-balancing collection of up to <strong>3</strong> worker nodes (instances).  Additionally, the deployment command we’ll be using below specifies <code class="highlighter-rouge">t2.large</code> instance types.  As always, feel free to modify the <code class="highlighter-rouge">amazon-eks-nodegroup.yaml</code> or instance types to meet your needs.</p>
</div>
</div>
  </li>
  <li>
    <p>Issue the following command to use the template and create your worker node collection.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> aws cloudformation deploy <span class="nt">--stack-name</span> spinnaker-eks-nodes <span class="nt">--template-file</span> amazon-eks-nodegroup.yaml <span class="se">\</span>
 <span class="nt">--parameter-overrides</span> <span class="nv">NodeInstanceProfile</span><span class="o">=</span><span class="nv">$SPINNAKER_INSTANCE_PROFILE_ARN</span> <span class="se">\</span>
 <span class="nv">NodeInstanceType</span><span class="o">=</span>t2.large <span class="nv">ClusterName</span><span class="o">=</span><span class="nv">$EKS_CLUSTER_NAME</span> <span class="nv">NodeGroupName</span><span class="o">=</span>spinnaker-cluster-nodes <span class="nv">ClusterControlPlaneSecurityGroup</span><span class="o">=</span><span class="nv">$CONTROL_PLANE_SG</span> <span class="se">\</span>
 <span class="nv">Subnets</span><span class="o">=</span><span class="nv">$SUBNETS</span> <span class="nv">VpcId</span><span class="o">=</span><span class="nv">$VPC_ID</span> <span class="nt">--capabilities</span> CAPABILITY_NAMED_IAM
</code></pre></div>    </div>
  </li>
  <li>
    <p>To connect up our newly-launched worker instances with the Spinnaker cluster we previously deployed we need to create a new <code class="highlighter-rouge">~/.kube/aws-auth-cm.yaml</code> file.  Paste the following text into <code class="highlighter-rouge">aws-auth-cm.yaml</code>, replacing <code class="highlighter-rouge">&lt;AUTH_ARN&gt;</code> with the <code class="highlighter-rouge">AUTH_ARN</code> variable created previously (Remember, you can use <code class="highlighter-rouge">echo $AUTH_ARN</code> to print to console).</p>

    <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
 <span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
 <span class="na">metadata</span><span class="pi">:</span>
   <span class="na">name</span><span class="pi">:</span> <span class="s">aws-auth</span>
   <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
 <span class="na">data</span><span class="pi">:</span>
   <span class="na">mapRoles</span><span class="pi">:</span> <span class="pi">|</span>
     <span class="no">- rolearn: &lt;AUTH_ARN&gt;</span>
       <span class="no">username: system:node:</span>
       <span class="no">groups:</span>
         <span class="no">- system:bootstrappers</span>
         <span class="no">- system:nodes</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Apply this newly created role mapping by issuing the following command.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> kubectl apply <span class="nt">-f</span> ~/.kube/aws-auth-cm.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Check the status of your Kubernetes nodes with <code class="highlighter-rouge">kubectl get nodes</code>.  The <code class="highlighter-rouge">--watch</code> flag can be added to perform constant updates.  Once all nodes have a <code class="highlighter-rouge">Ready</code> <strong>STATUS</strong> you’re all set to deploy Spinnaker.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> kubectl get nodes
 NAME                                          STATUS    ROLES     AGE       VERSION
 ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    2m        v1.10.3
 ip-10-100-10-210.us-west-2.compute.internal   Ready     &lt;none&gt;    2m        v1.10.3
 ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    2m        v1.10.3
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="deploy-spinnaker">Deploy Spinnaker</h3>

<ol>
  <li>
    <p>Start by listing the current Spinnaker versions with <code class="highlighter-rouge">hal version list</code>:</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal version list
</code></pre></div>    </div>
  </li>
  <li>
    <p>Specify the version you wish to install with the <code class="highlighter-rouge">--version</code> flag below.  We’ll be using the latest at the time of writing, <code class="highlighter-rouge">1.9.2</code>.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal config version edit <span class="nt">--version</span> 1.9.2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now use <code class="highlighter-rouge">hal deploy apply</code> to deploy Spinnaker using all the configuration settings we’ve previously applied.  This will go about distributing Spinnaker in your EKS/Kubernetes cluster.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> hal deploy apply
</code></pre></div>    </div>

    <div class="premonition error modified">
<div class="fa fa-exclamation-triangle"></div>
<div class="content">
<p class="header">Handling `hal deploy apply` Errors</p>
<p>In some cases you may experience a deployment error, particularly when trying your first Spinnaker deployment.  Often the console output is quite vague, so the best course of action is to check your Spinnaker/Halyard log files.  Typically these are located in <code class="highlighter-rouge">/var/log/spinnaker</code> and <code class="highlighter-rouge">/var/log/spinnaker/halyard</code>.  Since Halyard runs on Java, logs let you see the entire Java error stack trace, rather than the basic (and often useless) error name.</p>
</div>
</div>

    <div class="premonition error modified">
<div class="fa fa-exclamation-triangle"></div>
<div class="content">
<p class="header">Profile-related `IndexOutOfBoundsException`</p>
<p>With recent Halyard/Spinnaker versions there’s a <a href="https://github.com/spinnaker/spinnaker/issues/3280" target="_blank" rel="noopener noreferrer">known bug</a> that you may experience in which an <code class="highlighter-rouge">IndexOutOfBoundsException</code> occurs during deployment when using the AWS provider.  The cause usually seems to be that Halyard is assuming an explicit <code class="highlighter-rouge">region</code> value in the YAML configuration file for the AWS account being used.  Even though the <code class="highlighter-rouge">aws</code> block in the config has a <code class="highlighter-rouge">defaultRegions</code> key, that seems to be ignored, which can cause this error.  The current solution is to manually edit the primary AWS account and explicitly set the <code class="highlighter-rouge">region</code> value, which should solve the issue and allow you to run a Spinnaker deployment.</p>
</div>
</div>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config provider aws account edit aws-primary <span class="nt">--add-region</span> us-west-2
</code></pre></div></div>

<p>That’s it, you should now have a Spinnaker deployment up and running on a Kubernetes cluster, using EKS and EC2 worker node instances!  Issue the <code class="highlighter-rouge">hal deploy connect</code> command to provide port forwarding on your local machine to the Kubernetes cluster running Spinnaker, then open <a href="http://localhost:9000">http://localhost:9000</a> to make sure everything is up and running.</p>

<p>Select the <code class="highlighter-rouge">spinnaker</code> app and you should see your <code class="highlighter-rouge">aws-primary</code> account with a <code class="highlighter-rouge">spinnaker-eks-nodes-NodeGroup</code> containing your three EC2 worker node instances.</p>

<p><img src="/gremlin-chaos-monkey/images/advanced-tips-kubernetes-spinnaker.png" alt="advanced-tips-kubernetes-spinnaker"></p>

<h3 id="next-steps-4">Next Steps</h3>

<p>From here you can <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-install-chaos-monkey">install</a> and <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-use-chaos-monkey">start using Chaos Monkey</a> to run Chaos Experiments directly on your Kubernetes cluster worker nodes!  Check out our <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-install-chaos-monkey">How to Install Chaos Monkey</a> tutorial to get started.</p>


        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-09-12T00:00:00-07:00">September 12, 2018</time></p>
        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
    
    
    
    
    
    <li><a href="/gremlin-chaos-monkey/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2018 Gabe Wyatt</div>

      </footer>
    </div>

    
  <script src="/gremlin-chaos-monkey/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>








  </body>
</html>