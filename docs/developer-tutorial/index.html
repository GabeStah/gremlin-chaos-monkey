<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.13.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Chaos Monkey Tutorial - A Step-by-Step Guide to Creating Failure on AWS - Gremlin: Chaos Monkey</title>
<meta name="description" content="A step-by-step guide on setting up and using Chaos Monkey with AWS, and also explores specific scenarios in which Chaos Monkey may (or may not) be relevant.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Gremlin: Chaos Monkey">
<meta property="og:title" content="Chaos Monkey Tutorial - A Step-by-Step Guide to Creating Failure on AWS">
<meta property="og:url" content="http://localhost:4000/gremlin-chaos-monkey/developer-tutorial/">








  <meta property="article:published_time" content="2018-09-12T00:00:00-07:00">





  

  


<link rel="canonical" href="http://localhost:4000/gremlin-chaos-monkey/developer-tutorial/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Gabe Wyatt",
      "url": "http://localhost:4000/gremlin-chaos-monkey",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/gremlin-chaos-monkey/feed.xml" type="application/atom+xml" rel="alternate" title="Gremlin: Chaos Monkey Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/gremlin-chaos-monkey/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->
<link rel="icon" href="https://www.gremlin.com/favicon-32x32.png" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/gremlin-chaos-monkey/">Gremlin: Chaos Monkey</a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/gremlin-chaos-monkey/notes">Notes to Editor</a>
            </li>
<li class="masthead__menu-item">
              <a href="https://drive.google.com/drive/folders/16PhHEJGZtF428eyko_6-2BxpDGAU9JhW?usp=sharing" target="_blank" rel="noopener noreferrer">Google Drive Exports</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="http://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="http://localhost:4000/gremlin-chaos-monkey/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Chaos Monkey Tutorial - A Step-by-Step Guide to Creating Failure on AWS</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox">
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Hub Pages</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/" class="">Chaos Monkey Guide for Engineers</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/origin-netflix" class="">The Origin of Chaos Monkey</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/developer-tutorial" class="">Chaos Monkey Tutorial</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/advanced-tips" class="">Advanced Developer Guide</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/simian-army" class="">The Simian Army</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/downloads-resources" class="">Chaos Monkey Resources</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives" class="">Chaos Monkey Alternatives</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Alternatives</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/azure" class="">Azure</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/docker" class="">Docker</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/google-cloud-platform" class="">Google Cloud Platform</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/kubernetes" class="">Kubernetes</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/openshift" class="">OpenShift</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/private-cloud" class="">Private Cloud</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/spring-boot" class="">Spring Boot</a></li>
          
            
            

            
            

            <li><a href="/gremlin-chaos-monkey/alternatives/vmware" class="">VMware</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Chaos Monkey Tutorial - A Step-by-Step Guide to Creating Failure on AWS">
    
    <meta itemprop="datePublished" content="September 12, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Chaos Monkey Tutorial - A Step-by-Step Guide to Creating Failure on AWS
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  29 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li>
<a href="#how-to-quickly-deploy-spinnaker-for-chaos-monkey">How to Quickly Deploy Spinnaker for Chaos Monkey</a>
    <ul>
      <li><a href="#creating-the-spinnaker-stack">Creating the Spinnaker Stack</a></li>
      <li><a href="#connecting-to-the-bastion-host">Connecting to the Bastion Host</a></li>
      <li><a href="#connecting-to-the-spinnaker-host">Connecting to the Spinnaker Host</a></li>
      <li><a href="#configuring-spinnaker">Configuring Spinnaker</a></li>
      <li><a href="#creating-an-application">Creating an Application</a></li>
      <li><a href="#adding-a-firewall">Adding a Firewall</a></li>
      <li><a href="#adding-a-load-balancer">Adding a Load Balancer</a></li>
      <li>
<a href="#creating-a-pipeline-in-spinnaker">Creating a Pipeline in Spinnaker</a>
        <ul>
          <li><a href="#adding-a-bake-stage">Adding a Bake Stage</a></li>
          <li><a href="#adding-a-deploy-stage">Adding a Deploy Stage</a></li>
          <li><a href="#adding-a-server-group">Adding a Server Group</a></li>
        </ul>
      </li>
      <li>
<a href="#executing-the-pipeline">Executing the Pipeline</a>
        <ul>
          <li><a href="#troubleshooting-pipeline-executions">Troubleshooting Pipeline Executions</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<a href="#how-to-install-chaos-monkey">How to Install Chaos Monkey</a>
    <ul>
      <li><a href="#installing-mysql">Installing MySQL</a></li>
      <li><a href="#setup-mysql-for-chaos-monkey">Setup MySQL for Chaos Monkey</a></li>
      <li><a href="#installing-chaos-monkey">Installing Chaos Monkey</a></li>
      <li><a href="#configure-spinnaker-for-chaos-monkey">Configure Spinnaker for Chaos Monkey</a></li>
    </ul>
  </li>
  <li><a href="#how-to-configure-chaos-monkey">How to Configure Chaos Monkey</a></li>
  <li>
<a href="#how-to-use-chaos-monkey">How to Use Chaos Monkey</a>
    <ul>
      <li>
<a href="#how-to-schedule-chaos-monkey-terminations">How to Schedule Chaos Monkey Terminations</a>
        <ul>
          <li><a href="#next-steps">Next Steps</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
            </nav>
          </aside>
        
        <p>This chapter will provide a step-by-step guide for setting up and using Chaos Monkey with AWS.  We also examine a handful of scenarios in which Chaos Monkey is not always the most relevant solution for Chaos Engineering implementation, due to its Spinnaker requirements and limited scope of only handling instance terminations.</p>

<h2 id="how-to-quickly-deploy-spinnaker-for-chaos-monkey">How to Quickly Deploy Spinnaker for Chaos Monkey</h2>

<p>Modern Chaos Monkey <strong>requires</strong> the use of <a href="https://www.spinnaker.io/" target="_blank" rel="noopener noreferrer">Spinnaker</a>, which is an open-source, multi-cloud continuous delivery platform developed by Netflix.  Spinnaker allows for automated deployments across multiple cloud platforms (such as AWS, Azure, Google Cloud Platform, and more).  Spinnaker can also be used to deploy across multiple accounts and regions, often using <strong>pipelines</strong> that define a series of events that should occur every time a new version is released.  Spinnaker is a powerful tool, but since both Spinnaker and Chaos Monkey were developed by and for Netflix’s own architecture, you’ll need to do the extra legwork to configure Spinnaker to work within your application and infrastructure.</p>

<p>That said, in this first section we’ll explore the fastest and simplest way to get Spinnaker up and running, which will then allow you to move onto <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-install-chaos-monkey">installing</a> and then <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-use-chaos-monkey">using</a>.</p>

<p>We’ll be deploying Spinnaker on AWS, and the easiest method for doing so is to use the <a href="https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/new?stackName=Spinnaker&amp;templateURL=https:%2F%2Fs3.amazonaws.com%2Faws-quickstart%2Fquickstart-spinnaker%2Ftemplates%2Fquickstart-spinnakercf.template" target="_blank" rel="noopener noreferrer">CloudFormation Quick Start</a> template.</p>

<div class="premonition info">
  <div class="fa fa-info-circle"></div>
  <div class="content">
    <p class="header">Looking to Deploy Spinnaker In Another Environment?</p>
    
<p>If you’re looking for the utmost control over your <code class="highlighter-rouge">Spinnaker</code> deployment you should check out our [How to Deploy a Spinnaker Stack for Chaos Monkey][#spinnaker-manual] guide, which provides a step-by-step tutorial for setting up Halyard and Spinnaker on a local or virtual machine of your choice.</p>

  </div>
</div>

<p>The <em>AWS Spinnaker Quick Start</em> will create a simple architecture for you containing two subnets (one public and one private) in a Virtual Private Cloud (VPC).  The public subnet contains a <a href="https://en.wikipedia.org/wiki/Bastion_host" target="_blank" rel="noopener noreferrer">Bastion host</a> instance designed to be strictly accessible, with just port 22 open for SSH access.  The Bastion host will then allow a pass through connection to the private subnet that is running Spinnaker.</p>

<p><img src="../images/developer-tutorial-aws-spinnaker-quick-start-architecture.png" alt="developer-tutorial-aws-spinnaker-quick-start-architecture" title="AWS Spinnaker Quick Start Architecture"></p>

<p><em>AWS Spinnaker Quick Start Architecture - <strong>Courtesy of AWS</strong></em></p>

<p>This quick start process will take about 10 - 15 minutes and is mostly automated.</p>

<h3 id="creating-the-spinnaker-stack">Creating the Spinnaker Stack</h3>

<ol>
  <li>
<em>(Optional)</em> If necessary, visit <a href="https://aws.amazon.com/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/</a> to sign up for or login to your AWS account.</li>
  <li>
<em>(Optional)</em> You’ll need at least one AWS EC2 Key Pair for securely connecting via SSH.
    <ol>
      <li>If you don’t have a KeyPair already start by opening the AWS Console and navigate to <strong>EC2 &gt; NETWORK &amp; SECURITY &gt; Key Pairs</strong>.</li>
      <li>Click <strong>Create Key Pair</strong> and enter an identifying name in the <strong>Key pair name</strong> field.</li>
      <li>Click <strong>Create</strong> to download the private <code class="highlighter-rouge">.pem</code> key file to your local system.</li>
      <li>Save this key to an appropriate location (typically your local user <code class="highlighter-rouge">~/.ssh</code> directory).</li>
    </ol>
  </li>
  <li>After you’ve signed into the AWS console visit <a href="https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/new?stackName=Spinnaker&amp;templateURL=https:%2F%2Fs3.amazonaws.com%2Faws-quickstart%2Fquickstart-spinnaker%2Ftemplates%2Fquickstart-spinnakercf.template" target="_blank" rel="noopener noreferrer">this page</a>, which should load the <a href="https://s3.amazonaws.com/aws-quickstart/quickstart-spinnaker/templates/quickstart-spinnakercf.template" target="_blank" rel="noopener noreferrer"><code class="highlighter-rouge">quickstart-spinnakercf.template</code></a>.</li>
  <li>Click <strong>Next</strong>.</li>
  <li>(Optional) If you haven’t already done so, you’ll need to create at least one AWS Access Key.</li>
  <li>Select the <strong>KeyName</strong> of the key pair you previously created.</li>
  <li>Input a secure password in the <strong>Password</strong> field.</li>
  <li>
<em>(Optional)</em> Modify the IP address range in the <strong>SSHLocation</strong> field to indicate what IP range is allowed to SSH into the Bastion host.  For example, if your public IP address is <code class="highlighter-rouge">1.2.3.4</code> you might enter <code class="highlighter-rouge">1.2.3.4/32</code> into this field.  If you aren’t sure, you can enter <code class="highlighter-rouge">0.0.0.0/0</code> to allow any IP address to connect, though this is obviously less secure.</li>
  <li>Click <strong>Next</strong>.</li>
  <li>
<em>(Optional)</em> Select an <strong>IAM Role</strong> with proper CloudFormation permissions necessary to deploy a stack.  If you aren’t sure, leave this blank and deployment will use your account’s permissions.</li>
  <li>Modify any other fields on this screen you wish, then click <strong>Next</strong> to continue.</li>
  <li>
    <p>Check the <strong>I acknowledge that AWS CloudFormation might create IAM resources with custom names.</strong> checkbox and click <strong>Create</strong> to generate the stack.</p>

    <div class="premonition warning modified">
<div class="fa fa-exclamation-circle"></div>
<div class="content"><p>If your AWS account already contains the <code class="highlighter-rouge">BaseIAMRole</code> AWS::IAM::Role you may have to delete it before this template will succeed.</p></div>
</div>
  </li>
  <li>Once the <code class="highlighter-rouge">Spinnaker</code> stack has a <code class="highlighter-rouge">CREATE_COMPLETE</code> <strong>Status</strong>, select the <strong>Outputs</strong> tab, which has some auto-generated strings you’ll need to paste in your terminal in the next section.</li>
</ol>

<h3 id="connecting-to-the-bastion-host">Connecting to the Bastion Host</h3>

<ol>
  <li>Copy the <strong>Value</strong> of the <strong>SSHString1</strong> field from the stack <strong>Outputs</strong> tab above.</li>
  <li>
    <p>Execute the <strong>SSHString1</strong> value in your terminal and enter <code class="highlighter-rouge">yes</code> when prompted to continue connecting to this host.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> ssh <span class="nt">-A</span> <span class="nt">-L</span> 9000:localhost:9000 <span class="nt">-L</span> 8084:localhost:8084 <span class="nt">-L</span> 8087:localhost:8087 ec2-user@54.244.189.78
</code></pre></div>    </div>

    <div class="premonition error modified">
<div class="fa fa-exclamation-triangle"></div>
<div class="content">
<p class="header">Permission denied (publickey).</p>
<p>If you received a permission denied SSH error you may have forgotten to place your <code class="highlighter-rouge">.pem</code> private key file that you downloaded from the AWS EC2 Key Pair creation page.  Make sure it is located in your <code class="highlighter-rouge">~/.ssh</code> user directory.  Otherwise you can specify the key by adding an optional <code class="highlighter-rouge">-i &lt;identify_file_path&gt;</code> flag, indicating the path to the <code class="highlighter-rouge">.pem</code> file.</p>
</div>
</div>
  </li>
  <li>
    <p>You should now be connected as the <code class="highlighter-rouge">ec2-user</code> to the Bastion instance.  Before you can connect to the Spinnaker instance you’ll probably need to copy your <code class="highlighter-rouge">.pem</code> file to the Spinnaker instance’s <code class="highlighter-rouge">~/.ssh</code> directory.</p>

    <ul>
      <li>
        <p>Once the key is copied, make sure you set proper permissions otherwise SSH will complain.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  chmod 400 ~/.ssh/my_key.pem
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<h3 id="connecting-to-the-spinnaker-host">Connecting to the Spinnaker Host</h3>

<ol>
  <li>
    <p>To connect to the Spinnaker instance copy and paste the <strong>SSHString2</strong> <strong>Value</strong> into the terminal.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> ssh –L 9000:localhost:9000 <span class="nt">-L</span> 8084:localhost:8084 <span class="nt">-L</span> 8087:localhost:8087 ubuntu@10.100.10.167 <span class="nt">-i</span> ~/.ssh/my_key.pem
</code></pre></div>    </div>
  </li>
  <li>
    <p>You should now be connected to the <code class="highlighter-rouge">SpinnakerWebServer</code>!</p>

    <div class="premonition warning modified">
<div class="fa fa-exclamation-circle"></div>
<div class="content">
<p class="header">System restart required</p>
<p>Upon connecting to the Spinnaker instance you may see a message indicating the system needs to be restarted.  You can do this through the AWS EC2 console, or just enter the <code class="highlighter-rouge">sudo reboot</code> command in the terminal, then reconnect after a few moments.</p>
</div>
</div>
  </li>
</ol>

<h3 id="configuring-spinnaker">Configuring Spinnaker</h3>

<p>The <a href="https://www.spinnaker.io/reference/architecture/" target="_blank" rel="noopener noreferrer">Spinnaker architecture</a> is composed of a collection of microservices that each handle various aspects of the entire service.  For example, <a href="https://github.com/spinnaker/deck" target="_blank" rel="noopener noreferrer">Deck</a> is the web interface you’ll spend most time interacting with, <a href="https://github.com/spinnaker/gate" target="_blank" rel="noopener noreferrer">Gate</a> is the API gateway that handles most communication between microservices, and <a href="https://github.com/spinnaker/clouddriver" target="_blank" rel="noopener noreferrer">CloudDriver</a> is the service that communicates and configures all cloud providers Spinnaker is working with.</p>

<p>Since so much of Spinnaker is blown out into smaller microservices, configuring Spinnaker can require messing with a few different files.  If there’s an issue you’ll likely have to look through individual logs for each different service, depending on the problem.</p>

<p>Spinnaker is configured through <code class="highlighter-rouge">/opt/spinnaker/config/spinnaker.yml</code> file.  However, this file will be overwritten by Halyard or other changes, so for user-generated configuration you should actually modify the <code class="highlighter-rouge">/opt/spinnaker/config/spinnaker-local.yml</code> file.  Here’s a basic example of what that file looks like.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /opt/spinnaker/config/spinnaker-local.yml</span>

<span class="na">global</span><span class="pi">:</span>
  <span class="na">spinnaker</span><span class="pi">:</span>
    <span class="na">timezone</span><span class="pi">:</span> <span class="s1">'</span><span class="s">America/Los_Angeles'</span>

<span class="na">providers</span><span class="pi">:</span>
  <span class="na">aws</span><span class="pi">:</span>
    <span class="c1"># For more information on configuring Amazon Web Services (aws), see</span>
    <span class="c1"># http://www.spinnaker.io/v1.0/docs/target-deployment-setup#section-amazon-web-services-setup</span>

    <span class="na">enabled</span><span class="pi">:</span> <span class="s">${SPINNAKER_AWS_ENABLED:</span><span class="no">false</span><span class="s">}</span>
    <span class="na">defaultRegion</span><span class="pi">:</span> <span class="s">${SPINNAKER_AWS_DEFAULT_REGION:us-west-2}</span>
    <span class="na">defaultIAMRole</span><span class="pi">:</span> <span class="s">Spinnaker-BaseIAMRole-GAT2AISI7TMJ</span>
    <span class="na">primaryCredentials</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
      <span class="c1"># Store actual credentials in $HOME/.aws/credentials. See spinnaker.yml</span>
      <span class="c1"># for more information, including alternatives.</span>

    <span class="c1">#  will be interpolated with the aws account name (e.g. "my-aws-account-keypair").</span>
    <span class="na">defaultKeyPairTemplate</span><span class="pi">:</span> <span class="s2">"</span><span class="s">-keypair"</span>

    <span class="c1"># ...</span>
</code></pre></div></div>

<p>Standalone Spinnaker installations (such as the one created via the <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-quickly-deploy-spinnaker-for-chaos-monkey">AWS Spinnaker Quick Start</a>) are configured directly through the <code class="highlighter-rouge">spinnaker.yml</code> and <code class="highlighter-rouge">spinnaker-local.yml</code> override configuration files.</p>

<h3 id="creating-an-application">Creating an Application</h3>

<p>In this section we’ll manually create a Spinnaker <strong>application</strong> containing a <strong>pipeline</strong> that first <em>bakes</em> a virtual machine image and then <em>deploys</em> that image to a cluster.</p>

<ol>
  <li>Open the Spinnaker web UI (<strong>Deck</strong>) and click <strong>Actions &gt; Create Application</strong>.</li>
  <li>Input <code class="highlighter-rouge">bookstore</code> in the <strong>Name</strong> field.</li>
  <li>Input your own email address in the <strong>Owner Email</strong> field.</li>
  <li>(Optional) If you’ve enabled Chaos Monkey in Spinnaker you can opt to enable Chaos Monkey by checking the <strong>Chaos Monkey &gt; Enabled</strong> box.</li>
  <li>Input <code class="highlighter-rouge">My bookstore application</code> in the <strong>Description</strong> field.</li>
  <li>Under <strong>Instance Health</strong>, tick the <strong>Consider only cloud provider health when executing tasks</strong> checkbox.</li>
  <li>Click <strong>Create</strong> to add your new application.</li>
</ol>

<p><img src="../images/developer-tutorial-add-spinnaker-application.png" alt="developer-tutorial-add-spinnaker-application" title="New Application Spinnaker Dialog"></p>

<h3 id="adding-a-firewall">Adding a Firewall</h3>

<ol>
  <li>Navigate to the <code class="highlighter-rouge">bookstore</code> application, <strong>INFRASTRUCTURE &gt; FIREWALLS</strong>, and click <strong>Create Firewall</strong>.</li>
  <li>Input <code class="highlighter-rouge">dev</code> in the <strong>Detail</strong> field.</li>
  <li>Input <code class="highlighter-rouge">Bookstore dev environment</code> in the <strong>Description</strong> field.</li>
  <li>Within the <strong>VPC</strong> dropdown select <code class="highlighter-rouge">SpinnakerVPC</code>.</li>
  <li>Under the <strong>Ingress</strong> header click <strong>Add new Firewall Rule</strong>. Set the following <strong>Firewall Rule</strong> settings.
    <ul>
      <li>
<strong>Firewall</strong>: <code class="highlighter-rouge">default</code>
</li>
      <li>
<strong>Protocol</strong>: <code class="highlighter-rouge">TCP</code>
</li>
      <li>
<strong>Start Port</strong>: <code class="highlighter-rouge">80</code>
</li>
      <li>
<strong>End Port</strong>: <code class="highlighter-rouge">80</code>
</li>
    </ul>
  </li>
  <li>Click the <strong>Create</strong> button to finalize the firewall settings.</li>
</ol>

<p><img src="../images/developer-tutorial-add-firewall-spinnaker.png" alt="developer-tutorial-add-firewall-spinnaker" title="Add Firewall Spinnaker Dialog"></p>

<h3 id="adding-a-load-balancer">Adding a Load Balancer</h3>

<ol>
  <li>Navigate to the <code class="highlighter-rouge">bookstore</code> application, <strong>INFRASTRUCTURE &gt; LOAD BALANCERS</strong>, and click <strong>Create Load Balancer</strong>.</li>
  <li>Select <strong>Classic (Legacy)</strong> and click <strong>Configure Load Balancer</strong>.</li>
  <li>Input <code class="highlighter-rouge">test</code> in the <strong>Stack</strong> field.</li>
  <li>In the <strong>VPC Subnet</strong> dropdown select <code class="highlighter-rouge">internal (vpc-...)</code>.</li>
  <li>In the <strong>Firewalls</strong> dropdown select <code class="highlighter-rouge">bookstore--dev (...)</code>.</li>
  <li>Click <strong>Create</strong> to generate the load balancer.</li>
</ol>

<p><img src="../images/developer-tutorial-add-load-balancer-spinnaker.png" alt="developer-tutorial-add-load-balancer-spinnaker" title="Add Load Balancer Spinnaker Dialog"></p>

<h3 id="creating-a-pipeline-in-spinnaker">Creating a Pipeline in Spinnaker</h3>

<p>The final step is to add a <strong>pipeline</strong>, which is where we tell Spinnaker what it should actually “do”!  In this case we’ll tell it to <strong>bake</strong> a virtual machine image containing <a href="https://redis.io/" target="_blank" rel="noopener noreferrer">Redis</a>, then to <strong>deploy</strong> that image to our waiting EC2 instance.</p>

<ol>
  <li>Navigate to the <code class="highlighter-rouge">bookstore</code> application, <strong>PIPELINES</strong> and click <strong>Create Pipeline</strong>.</li>
  <li>Select <code class="highlighter-rouge">Pipeline</code> in the <strong>Type</strong> dropdown.</li>
  <li>Input <code class="highlighter-rouge">Bookstore Dev to Test</code> in the <strong>Pipeline Name</strong> field.</li>
  <li>Click <strong>Create</strong>.</li>
</ol>

<h4 id="adding-a-bake-stage">Adding a Bake Stage</h4>

<ol>
  <li>Click the <strong>Add stage</strong> button.</li>
  <li>Under <strong>Type</strong> select <code class="highlighter-rouge">Bake</code>.</li>
  <li>Input <code class="highlighter-rouge">redis-server</code> in the <strong>Package</strong> field.</li>
  <li>Select <code class="highlighter-rouge">trusty (v14.04)</code> in the <strong>Base OS</strong> dropdown.</li>
  <li>Click <strong>Save Changes</strong> to finalize the stage.</li>
</ol>

<p><img src="../images/developer-tutorial-bake-stage-spinnaker.png" alt="developer-tutorial-bake-stage-spinnaker" title="Add Bake Deployment Stage Spinnaker Dialog"></p>

<div class="premonition note modified">
<div class="fa fa-check-square"></div>
<div class="content">
<p class="header">Ignoring Jenkins/Travis</p>
<p>In production environments you’ll likely also want to incorporate Travis, Jenkins, or another CI solution as a preceding stage to the <strong>bake</strong> stage.  Otherwise, Spinnaker will default to baking and deploying the most recently built package.  For our purposes here we don’t care, since we’re using an unchanging image.</p>
</div>
</div>

<h4 id="adding-a-deploy-stage">Adding a Deploy Stage</h4>

<ol>
  <li>Click the <strong>Add stage</strong> button.</li>
  <li>Under <strong>Type</strong> select <code class="highlighter-rouge">Deploy</code>.</li>
  <li>Click the <strong>Add server group</strong> button to begin creating a new server group.</li>
</ol>

<h4 id="adding-a-server-group">Adding a Server Group</h4>

<ol>
  <li>Select <code class="highlighter-rouge">internal (vpc-...)</code> in the <strong>VPC Subnet</strong> dropdown.</li>
  <li>Input <code class="highlighter-rouge">dev</code> in the <strong>Stack</strong> field.</li>
  <li>Under <strong>Load Balancers &gt; Classic Load Balancers</strong> select the <code class="highlighter-rouge">bookstore-dev</code> load balancer we created.</li>
  <li>Under <strong>Firewalls &gt; Firewalls</strong> select the <code class="highlighter-rouge">bookstore--dev</code> firewall we also created.</li>
  <li>Under <strong>Instance Type</strong> select the <strong>Custom Type</strong> of instance you think you’ll need.  For this example we’ll go with something small and cheap, such as <code class="highlighter-rouge">t2.large</code>.</li>
  <li>Input <code class="highlighter-rouge">3</code> in the <strong>Capacity &gt; Number of Instances</strong> field.</li>
  <li>Under <strong>Advanced Settings &gt; Key Name</strong> select the key pair name you used when <a href="/gremlin-chaos-monkey/developer-tutorial#how-to-quickly-deploy-spinnaker-for-chaos-monkey">deploying</a> your Spinnaker CloudFormation stack.</li>
  <li>In the <strong>Advanced Settings &gt; IAM Instance Profile</strong> field input the <strong>Instance Profile ARN</strong> value of the <code class="highlighter-rouge">BaseIAMRole</code> found in the <strong>AWS &gt; IAM &gt; Roles &gt; BaseIAMRole</strong> dialog (e.g. <code class="highlighter-rouge">arn:aws:iam::0123456789012:instance-profile/BaseIAMRole</code>).</li>
  <li>We also need to ensure the <code class="highlighter-rouge">user/Spinnaker-SpinnakerUser</code> that was generated has permissions to perform to pass the <code class="highlighter-rouge">role/BasIAMRole</code> <strong>role</strong> during deployment.
    <ol>
      <li>Navigate to <strong>AWS &gt; IAM &gt; Users &gt; Spinnaker-SpinnakerUser-### &gt; Permissions</strong>.</li>
      <li>Expand <code class="highlighter-rouge">Spinnakerpassrole</code> policy and click <strong>Edit Policy</strong>.</li>
      <li>Select the <strong>JSON</strong> tab and you’ll see the auto-generated <code class="highlighter-rouge">Spinnaker-BaseIAMRole</code> listed in <code class="highlighter-rouge">Resources</code>.</li>
      <li>
        <p>Convert the <code class="highlighter-rouge">Resource</code> key value to an array so you can add a second value.  Insert the <strong>ARN</strong> for the <code class="highlighter-rouge">role/BaseIAMRole</code> of your account (the account number will match the number above).</p>

        <div class="language-json highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
     </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
         </span><span class="p">{</span><span class="w">
             </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VisualEditor0"</span><span class="p">,</span><span class="w">
             </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
             </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iam:PassRole"</span><span class="p">,</span><span class="w">
             </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                 </span><span class="s2">"arn:aws:iam::123456789012:role/Spinnaker-BaseIAMRole-6D9LJ9HS4PZ7"</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"arn:aws:iam::123456789012:role/BaseIAMRole"</span><span class="w">
             </span><span class="p">]</span><span class="w">
         </span><span class="p">}</span><span class="w">
     </span><span class="p">]</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>Click <strong>Review Policy</strong> and <strong>Save Changes</strong>.</li>
    </ol>
  </li>
  <li>Click the <strong>Add</strong> button to create the deployment cluster configuration.</li>
  <li>Finally, click <strong>Save Changes</strong> again at the bottom of the <strong>Pipelines</strong> interface to save the full <code class="highlighter-rouge">Configuration &gt; Bake &gt; Deploy</code> pipeline.</li>
  <li>You should now have a <code class="highlighter-rouge">Bookstore Dev to Test</code> two-stage <strong>pipeline</strong> ready to go!</li>
</ol>

<p><img src="../images/developer-tutorial-add-pipeline-spinnaker.png" alt="developer-tutorial-add-pipeline-spinnaker" title="Bookstore Dev to Test Pipeline"></p>

<h3 id="executing-the-pipeline">Executing the Pipeline</h3>

<ol>
  <li>Navigate to the <code class="highlighter-rouge">bookstore</code> application, select <strong>Pipelines</strong>, and click <strong>Start Manual Execution</strong> next to the <code class="highlighter-rouge">Bookstore Dev to Test</code> pipeline.</li>
  <li>Click <strong>Run</strong> to begin manual execution.</li>
  <li>After waiting a few moments, assuming none of the potential setbacks below bite you, you’ll shortly see output indicating the <code class="highlighter-rouge">bookstore-dev-v000</code> <strong>Server Group</strong> has been successfully created.  Browse over to <strong>AWS &gt; EC2</strong> and you’ll see your three new instances launched!</li>
</ol>

<p><img src="../images/developer-tutorial-mr-burns-excellent.gif" alt="mr-burns-excellent" title="Mr. Burns - Excellent"></p>

<p>To resize this <strong>Server Group</strong> use the <strong>Resize Server Group</strong> dialog in Spinnaker.  Alternatively, you can find additional options under <strong>Server Group Actions</strong>, such as <strong>Disable</strong> or <strong>Destroy</strong> to stop or terminate instances, respectively.</p>

<h4 id="troubleshooting-pipeline-executions">Troubleshooting Pipeline Executions</h4>

<p>While a lot can go wrong, below are a few potential issues you may encounter running through this tutorial, depending on changes to software versions, default configurations, and the like between present and time of writing.</p>

<div class="premonition error modified">
<div class="fa fa-exclamation-triangle"></div>
<div class="content">
<p class="header">Error: Unknown configuration key `ena_support`</p>
<p>If you get an <code class="highlighter-rouge">ena_support</code> error during deployment (see: <a href="https://github.com/spinnaker/spinnaker/issues/2237" target="_blank" rel="noopener noreferrer">#2237</a>) the solution is to <em>remove</em> the <code class="highlighter-rouge">ena_support</code> reference line  within the <code class="highlighter-rouge">builders</code> block in the <code class="highlighter-rouge">/opt/rosco/config/packer/aws-ebs.json</code> Rosco configuration file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /opt/rosco/config/packer/aws-ebs.json
</code></pre></div></div>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"builders"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"aws_ena_support"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_ena_support`}}"</span><span class="p">,</span><span class="w">
  </span><span class="p">},</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
</div>
</div>

<div class="premonition error modified">
<div class="fa fa-exclamation-triangle"></div>
<div class="content">
<p class="header">Error: `0.000000` is an invalid spot instance price</p>
<p>If you get such an error during deployment (see: <a href="https://github.com/spinnaker/spinnaker/issues/2889" target="_blank" rel="noopener noreferrer">#2889</a>) the solution is to <em>remove</em> <code class="highlighter-rouge">spot_price</code> reference lines within the <code class="highlighter-rouge">builders</code> block in the <code class="highlighter-rouge">/opt/rosco/config/packer/aws-ebs.json</code> Rosco configuration file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /opt/rosco/config/packer/aws-ebs.json
</code></pre></div></div>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"builders"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"spot_price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_spot_price`}}"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"spot_price_auto_product"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_spot_price_auto_product`}}"</span><span class="p">,</span><span class="w">
  </span><span class="p">},</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
</div>
</div>

<div class="premonition error modified">
<div class="fa fa-exclamation-triangle"></div>
<div class="content">
<p class="header">Error: Bake stage failure after provisioning `install_packages.sh` script</p>
<p>This error is typically due to an outdated <code class="highlighter-rouge">install_packages.sh</code> script.  To resolve this override with the latest downloaded version.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>curl https://raw.githubusercontent.com/spinnaker/rosco/master/rosco-web/config/packer/install_packages.sh <span class="nt">--output</span> /opt/rosco/config/packer/install_packages.sh
</code></pre></div></div>
</div>
</div>

<h2 id="how-to-install-chaos-monkey">How to Install Chaos Monkey</h2>

<p>Before you can use Chaos Monkey you’ll need to have Spinnaker deployed and running.  We’ve created a handful of step-by-step tutorials for deploying Spinnaker, depending on the environment and level of control you’re looking for.</p>

<ul>
  <li>
<a href="/gremlin-chaos-monkey/developer-tutorial#how-to-quickly-deploy-spinnaker-for-chaos-monkey">How to Quickly Deploy Spinnaker for Chaos Monkey</a> will guide you through a rapid deployment of Spinnaker on AWS.</li>
  <li>
<a href="/gremlin-chaos-monkey/advanced-tips#how-to-deploy-a-spinnaker-stack-for-chaos-monkey">How to Deploy a Spinnaker Stack for Chaos Monkey</a> provides a much more in-depth tutorial for installing Spinnaker as it was intended, with the help of the Halyard tool, on a local or virtual machine.</li>
</ul>

<h3 id="installing-mysql">Installing MySQL</h3>

<p>Chaos Monkey requires MySQL, so make sure it’s installed on your local system.</p>

<div class="premonition warning modified">
<div class="fa fa-exclamation-circle"></div>
<div class="content">
<p class="header">Warning</p>
<p>Chaos Monkey is currently <em>incompatible</em> with MySQL version 8.0 or higher, so 5.X is recommended.</p>
</div>
</div>

<ol>
  <li>
    <p>Download the latest <code class="highlighter-rouge">mysql-apt.deb</code> file from the <a href="https://dev.mysql.com/downloads/repo/apt/" target="_blank" rel="noopener noreferrer">official website</a>, which we’ll use to install MySQL</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-OL</span> https://dev.mysql.com/get/mysql-apt-config_0.8.10-1_all.deb
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install <code class="highlighter-rouge">mysql-server</code> by using the <code class="highlighter-rouge">dpkg</code> command.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>dpkg <span class="nt">-i</span> mysql-apt-config_0.8.10-1_all.deb
</code></pre></div>    </div>
  </li>
  <li>
    <p>In the UI that appears press enter to change the <strong>MySQL Server &amp; Cluster</strong> version to <code class="highlighter-rouge">mysql-5.7</code>.  Leave the other options as default and move down to <code class="highlighter-rouge">Ok</code> and press <code class="highlighter-rouge">Enter</code> to finalize your choice.</p>

    <p><img src="../images/advanced-tips-mysql-install.png" alt="advanced-tips-mysql-install"></p>
  </li>
  <li>
    <p>Now use <code class="highlighter-rouge">sudo apt-get update</code> to update the MySQL packages related to the version we selected (<code class="highlighter-rouge">mysql-5.7</code>, in this case).</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>apt-get update
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install <code class="highlighter-rouge">mysql-server</code> from the packages we just retrieved.  You’ll be prompted to enter a <code class="highlighter-rouge">root</code> password.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>apt-get install mysql-server
</code></pre></div>    </div>
  </li>
  <li>
    <p>You’re all set.  Check that MySQL server is running with <code class="highlighter-rouge">systemctl</code>.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> systemctl status mysql
</code></pre></div>    </div>
  </li>
  <li>
    <p><em>(Optional)</em> You may also wish to issue the <code class="highlighter-rouge">mysql_secure_installation</code> command, which will walk you through a few security-related prompts.  Typically, the defaults are just fine.</p>
  </li>
</ol>

<h3 id="setup-mysql-for-chaos-monkey">Setup MySQL for Chaos Monkey</h3>

<p>We now need to add a MySQL table for Chaos Monkey to use and create an associated user with appropriate permissions.</p>

<ol>
  <li>
    <p>Launch the <code class="highlighter-rouge">mysql</code> CLI as the <code class="highlighter-rouge">root</code> user.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> mysql <span class="nt">-u</span> root <span class="nt">-p</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create a <code class="highlighter-rouge">chaosmonkey</code> database for Chaos Monkey to use.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> CREATE DATABASE chaosmonkey<span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add a <code class="highlighter-rouge">chaosmonkey</code> MySQL user.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> CREATE USER <span class="s1">'chaosmonkey'</span>@<span class="s1">'localhost'</span> IDENTIFIED BY <span class="s1">'password'</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Grant all privileges in the <code class="highlighter-rouge">chaosmonkey</code> database to the new <code class="highlighter-rouge">chaosmonkey</code> user.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> GRANT ALL PRIVILEGES ON chaosmonkey.<span class="k">*</span> TO <span class="s1">'chaosmonkey'</span>@<span class="s1">'localhost'</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Finally, save all changes made to the system.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> FLUSH PRIVILEGES<span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="installing-chaos-monkey">Installing Chaos Monkey</h3>

<ol>
  <li>
    <p><em>(Optional)</em> Install <code class="highlighter-rouge">go</code> if you don’t have it on your local machine already.</p>

    <ol>
      <li>
        <p>Go to <a href="https://golang.org/dl/" target="_blank" rel="noopener noreferrer">this</a> download page and download the latest binary appropriate to your environment.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-O</span> https://dl.google.com/go/go1.11.linux-amd64.tar.gz
</code></pre></div>        </div>
      </li>
      <li>
        <p>Extract the archive to the <code class="highlighter-rouge">/usr/local</code> directory.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo tar</span> <span class="nt">-C</span> /usr/local <span class="nt">-xzf</span> go1.11.linux-amd64.tar.gz
</code></pre></div>        </div>
      </li>
      <li>
        <p>Add <code class="highlighter-rouge">/usr/local/go/bin</code> to your <code class="highlighter-rouge">$PATH</code> environment variable.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/go/bin
 <span class="nb">echo</span> <span class="s1">'export PATH=$PATH:/usr/local/go/bin'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>
    <p><em>(Optional)</em> Check if the <code class="highlighter-rouge">$GOPATH</code> and <code class="highlighter-rouge">$GOBIN</code> variables are set with <code class="highlighter-rouge">echo $GOPATH</code> and <code class="highlighter-rouge">echo $GOBIN</code>.  If not, <code class="highlighter-rouge">export</code> them and add them to your bash profile.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/go
 <span class="nb">echo</span> <span class="s1">'export GOPATH=$HOME/go'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
 <span class="nb">export </span><span class="nv">GOBIN</span><span class="o">=</span><span class="nv">$HOME</span>/go/bin
 <span class="nb">echo</span> <span class="s1">'export GOBIN=$HOME/go/bin'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
 <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$GOBIN</span>
 <span class="nb">echo</span> <span class="s1">'export PATH=$PATH:$GOBIN'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install the latest Chaos Monkey binary.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> go get github.com/netflix/chaosmonkey/cmd/chaosmonkey
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="configure-spinnaker-for-chaos-monkey">Configure Spinnaker for Chaos Monkey</h3>

<p>Spinnaker includes the Chaos Monkey feature as an option, but it is disabled by default.</p>

<ol>
  <li>
<em>(Optional)</em> If necessary, enable the Chaos Monkey feature in your Spinnaker deployment.
    <ul>
      <li>On a Halyard-based Spinnaker deployment you must enable the Chaos Monkey feature via the Halyard <code class="highlighter-rouge">--chaos</code> flag.
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  hal config features edit <span class="nt">--chaos</span> <span class="nb">true</span>
</code></pre></div>        </div>
      </li>
      <li>On a quick start Spinnaker deployment you’ll need to manually enable the Chaos Monkey feature flag within the <code class="highlighter-rouge">/opt/deck/html/settings.js</code> file.  Make sure the <code class="highlighter-rouge">var chaosEnabled</code> is set to <code class="highlighter-rouge">true</code>, then save and reload Spinnaker.
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="nb">sudo </span>nano /opt/deck/html/settings.js
</code></pre></div>        </div>
        <div class="language-js highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c1">// var chaosEnabled = ${services.chaos.enabled};</span>
  <span class="kd">var</span> <span class="nx">chaosEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Navigate to <strong>Applications &gt; (APPLICATION_NAME) &gt; CONFIG</strong> and select <strong>CHAOS MONKEY</strong> in the side navigation.</p>

    <p><img src="../images/advanced-tips-config-chaos-monkey.png" alt="advanced-tips-config-chaos-monkey" title="Chaos Monkey Spinnaker Dialog"></p>
  </li>
  <li>Check the <strong>Enabled</strong> box to enable Chaos Monkey.</li>
  <li>The UI provides useful information for what every option does, but the most important options are the <strong>mean</strong> and <strong>min</strong> times between instance termination.  If your setup includes multiple clusters or stacks, altering the <strong>grouping</strong> may also make sense.  Finally, you can add <strong>exceptions</strong> as necessary, which acts as a kind of <em>whitelist</em> of instances that will be ignored by Chaos Monkey, so you can keep the most critical services up and running.</li>
  <li>Once your changes are made click the <strong>Save Changes</strong> button.</li>
</ol>

<h2 id="how-to-configure-chaos-monkey">How to Configure Chaos Monkey</h2>

<ol>
  <li>Start by creating the <code class="highlighter-rouge">chaosmonkey.toml</code>, which Chaos Monkey will try to find in all of the following locations, until a configuration file is found:
    <ul>
      <li><em>(current directory)</em></li>
      <li><code class="highlighter-rouge">/apps/chaosmonkey</code></li>
      <li><code class="highlighter-rouge">/etc</code></li>
      <li><code class="highlighter-rouge">/etc/chaosmonkey</code></li>
    </ul>
  </li>
</ol>

<div class="premonition tip modified">
<div class="fa fa-check-square"></div>
<div class="content"><p>Generally, if you’re configuring <em>multiple</em> Chaos Monkey installations on the same machine you should use application-specific configurations, so putting them in separate directories is ideal.  However, if you’re just using one installation on the machine then <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey.toml</code> works well.</p></div>
</div>

<ol>
  <li>
    <p>Add the following basic configuration structure to your <code class="highlighter-rouge">chaosmonkey.toml</code> file, replacing appropriate <code class="highlighter-rouge">&lt;DATABASE_&gt;</code> configuration values with your own settings.</p>

    <div class="language-toml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nn">[chaosmonkey]</span>
 <span class="py">enabled</span> <span class="p">=</span> <span class="kc">true</span>
 <span class="py">schedule_enabled</span> <span class="p">=</span> <span class="kc">true</span>
 <span class="py">leashed</span> <span class="p">=</span> <span class="kc">false</span>
 <span class="py">accounts</span> <span class="p">=</span> <span class="nn">["aws-primary"]</span>

 <span class="py">start_hour</span> <span class="p">=</span> <span class="mi">9</span>      <span class="c"># time during day when starts terminating</span>
 <span class="py">end_hour</span> <span class="p">=</span> <span class="mi">15</span>       <span class="c"># time during day when stops terminating</span>

 <span class="c"># location of command Chaos Monkey uses for doing terminations</span>
 <span class="py">term_path</span> <span class="p">=</span> <span class="s">"/apps/chaosmonkey/chaosmonkey-terminate.sh"</span>

 <span class="c"># cron file that Chaos Monkey writes to each day for scheduling kills</span>
 <span class="py">cron_path</span> <span class="p">=</span> <span class="s">"/etc/cron.d/chaosmonkey-schedule"</span>

 <span class="nn">[database]</span>
 <span class="py">host</span> <span class="p">=</span> <span class="s">"localhost"</span>
 <span class="py">name</span> <span class="p">=</span> <span class="s">"&lt;DATABASE_NAME&gt;"</span>
 <span class="py">user</span> <span class="p">=</span> <span class="s">"&lt;DATABASE_USER&gt;"</span>
 <span class="py">encrypted_password</span> <span class="p">=</span> <span class="s">"&lt;DATABASE_USER_PASSWORD&gt;"</span>

 <span class="nn">[spinnaker]</span>
 <span class="py">endpoint</span> <span class="p">=</span> <span class="s">"http://localhost:8084"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>With Chaos Monkey configured it’s time to migrate it to the MySQL</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>chaosmonkey migrate
 <span class="o">[</span>16264] 2018/09/04 14:11:16 Successfully applied database migrations. Number of migrations applied:  1
 <span class="o">[</span>16264] 2018/09/04 14:11:16 database migration applied successfully
</code></pre></div>    </div>
  </li>
</ol>

<div class="premonition error modified">
<div class="fa fa-exclamation-triangle"></div>
<div class="content">
<p class="header">Error: 1298: Unknown or incorrect time zone: 'UTC'</p>
<p>If you experience a timezone error this typically indicates a configuration problem with MySQL.  Just run the <code class="highlighter-rouge">mysql_tzinfo_to_sql</code> command to update your MySQL installation.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql_tzinfo_to_sql /usr/share/zoneinfo/ | mysql <span class="nt">-u</span> root mysql <span class="nt">-p</span>
</code></pre></div></div>
</div>
</div>

<h2 id="how-to-use-chaos-monkey">How to Use Chaos Monkey</h2>

<p>Using the <code class="highlighter-rouge">chaosmonkey</code> command line tool is fairly simple.  Start by making sure it can connect to your <code class="highlighter-rouge">spinnaker</code> instance with <code class="highlighter-rouge">chaosmonkey config spinnaker</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chaosmonkey config spinnaker
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OUTPUT</span>
<span class="o">(</span><span class="k">*</span>chaosmonkey.AppConfig<span class="o">)(</span>0xc00006ca00<span class="o">)({</span>
 Enabled: <span class="o">(</span>bool<span class="o">)</span> <span class="nb">true</span>,
 RegionsAreIndependent: <span class="o">(</span>bool<span class="o">)</span> <span class="nb">true</span>,
 MeanTimeBetweenKillsInWorkDays: <span class="o">(</span>int<span class="o">)</span> 2,
 MinTimeBetweenKillsInWorkDays: <span class="o">(</span>int<span class="o">)</span> 1,
 Grouping: <span class="o">(</span>chaosmonkey.Group<span class="o">)</span> cluster,
 Exceptions: <span class="o">([]</span>chaosmonkey.Exception<span class="o">)</span> <span class="o">{</span>
 <span class="o">}</span>,
 Whitelist: <span class="o">(</span><span class="k">*</span><span class="o">[]</span>chaosmonkey.Exception<span class="o">)(</span>&lt;nil&gt;<span class="o">)</span>
<span class="o">})</span>
</code></pre></div></div>

<div class="premonition tip modified">
<div class="fa fa-check-square"></div>
<div class="content">
<p>If you’re running Spinnaker on Kubernetes you can use the <code class="highlighter-rouge">kubectl get nodes --watch</code> command to keep track of your Kubernetes nodes while running Chaos Experiments.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes <span class="nt">--watch</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OUTPUT</span>
ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-210.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
</code></pre></div></div>
</div>
</div>

<p>To manually terminate an instance with Chaos Monkey use the <code class="highlighter-rouge">chaosmonkey terminate</code> command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chaosmonkey terminate &lt;app&gt; &lt;account&gt; <span class="o">[</span><span class="nt">--region</span><span class="o">=</span>&lt;region&gt;] <span class="o">[</span><span class="nt">--stack</span><span class="o">=</span>&lt;stack&gt;] <span class="o">[</span><span class="nt">--cluster</span><span class="o">=</span>&lt;cluster&gt;] <span class="o">[</span><span class="nt">--leashed</span><span class="o">]</span>
</code></pre></div></div>

<p>For this example our <strong>application</strong> is <code class="highlighter-rouge">spinnaker</code> and our <strong>account</strong> is <code class="highlighter-rouge">aws-primary</code>, so using just those two values and leaving the rest default should work.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chaosmonkey terminate spinnaker aws-primary
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OUTPUT</span>
<span class="o">[</span>11533] 2018/09/08 18:39:26 Picked: <span class="o">{</span>spinnaker aws-primary us-west-2 eks spinnaker-eks-nodes-NodeGroup-KLBYTZDP0F89 spinnaker-eks-nodes-NodeGroup-KLBYTZDP0F89 i-054152fc4ed41d7b7 aws<span class="o">}</span>
</code></pre></div></div>

<p>Now look at the AWS EC2 console (or at the terminal window running <code class="highlighter-rouge">kubectl get nodes --watch</code>) and after a moment you’ll see one of the instances has been terminated.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-210.us-west-2.compute.internal   NotReady   &lt;none&gt;    3d        v1.10.3
ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
</code></pre></div></div>

<p><img src="https://media.giphy.com/media/3ohzdIuqJoo8QdKlnW/giphy.gif" alt="awesome-gif"></p>

<p>If you quickly open up the Spinnaker Deck web interface you’ll see only two of the three instances in the cluster are active, as we see in <code class="highlighter-rouge">kubectl</code> above.  However, wait a few more moments and Spinnaker will notice the loss of an instance, recognize it has been stopped/terminated due to an EC2 health check, and will immediately propagate a new instance to replace it, thus ensuring the server group’s desired capacity remains at <code class="highlighter-rouge">3</code> instances.</p>

<p>For Kubernetes Spinnaker deployments, a <code class="highlighter-rouge">kubectl get nodes --watch</code> output confirms these changes (in this case, the new local <code class="highlighter-rouge">ip-10-100-11-180.us-west-2.compute.internal</code> instance was added).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-11-180.us-west-2.compute.internal   NotReady  &lt;none&gt;    10s       v1.10.3
ip-10-100-11-239.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-10-178.us-west-2.compute.internal   Ready     &lt;none&gt;    3d        v1.10.3
ip-10-100-11-180.us-west-2.compute.internal   Ready     &lt;none&gt;    20s       v1.10.3
</code></pre></div></div>

<p>Spinnaker also tracks this information.  Navigating to the your Spinnaker application <strong>INFRASTRUCTURE &gt; CLUSTERS &gt; <code class="highlighter-rouge">spinnaker-eks-nodes-NodeGroup</code> &gt; CAPACITY</strong> and click <strong>View Scaling Activities</strong> to see the Spinnaker scaling activities log for this node group.  In this case we see the successful activities that lead to the health check failure and new instance start.</p>

<p><img src="../images/advanced-tips-nodegroup-scaling-activities.png" alt="advanced-tips-nodegroup-scaling-activities"></p>

<h3 id="how-to-schedule-chaos-monkey-terminations">How to Schedule Chaos Monkey Terminations</h3>

<p>Before we get to scheduling anything you’ll want to copy the <code class="highlighter-rouge">chaosmonkey</code> executable to the <code class="highlighter-rouge">/apps/chaosmonkey</code> directory.  While you can leave it in the default <code class="highlighter-rouge">$GOBIN</code> directory, it’ll be easier to use with cron jobs and other system commands if it’s in a global location.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>cp ~/go/bin/chaosmonkey /apps/chaosmonkey/
</code></pre></div></div>

<p>Now that we’ve confirmed we can manually terminate instances via Chaos Monkey you may want to setup an automated system for doing so.  The primary way to do this is to create a series of scripts that regenerate a unique <code class="highlighter-rouge">crontab</code> job that is scheduled to execute on a specific date and time.  This cron job is created every day (or however often you like), and the execution time is randomized based on the <code class="highlighter-rouge">start_hour</code>, <code class="highlighter-rouge">end_hour</code>, and <code class="highlighter-rouge">time_zone</code> settings in the <code class="highlighter-rouge">chaosmonkey.toml</code> configuration.  We’ll be using four files for this: Two crontab files and two bash scripts.</p>

<ol>
  <li>
    <p>Start by creating the four files we’ll be using for this.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>touch /apps/chaosmonkey/chaosmonkey-schedule.sh
 <span class="nb">sudo </span>touch /apps/chaosmonkey/chaosmonkey-terminate.sh
 <span class="nb">sudo </span>touch /etc/cron.d/chaosmonkey-schedule
 <span class="nb">sudo </span>touch /etc/cron.d/chaosmonkey-daily-scheduler
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now set executable permissions for the two bash scripts so the cron (root) user can execute them.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>chmod a+rx /apps/chaosmonkey/chaosmonkey-schedule.sh
 <span class="nb">sudo </span>chmod a+rx /apps/chaosmonkey/chaosmonkey-terminate.sh
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now we’ll add some commands to each script in the order they’re expected to call one another.  First, the <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-daily-scheduler</code> is executed once a day at a time you specify.  This will call the <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-schedule.sh</code> script, which will perform the actual scheduling for termination.  Paste the following into <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-daily-scheduler</code> (as with any cron job you can freely edit the schedule to determine when the cron job should be executed).</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="c"># min  hour  dom  month  day  user  command</span>
 0      12    <span class="k">*</span>    <span class="k">*</span>      <span class="k">*</span>    root  /apps/chaosmonkey/chaosmonkey-schedule.sh
</code></pre></div>    </div>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-schedule.sh</code> script should perform the actual <code class="highlighter-rouge">chaosmonkey schedule</code> command, so paste the following into <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-schedule.sh</code>.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 /apps/chaosmonkey/chaosmonkey schedule <span class="o">&gt;&gt;</span> /var/log/chaosmonkey-schedule.log 2&gt;&amp;1
</code></pre></div>    </div>
  </li>
  <li>
    <p>When the <code class="highlighter-rouge">chaosmonkey schedule</code> command is called by the <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-schedule.sh</code> script it will automatically write to the <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-schedule</code> file with a randomized timestamp for execution based on the Chaos Monkey configuration.  Here’s an example of what the generated <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-schedule</code> looks like.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="c"># /etc/cron.d/chaosmonkey-schedule</span>
 9 16 9 9 0 root /apps/chaosmonkey/chaosmonkey-terminate.sh spinnaker aws-primary <span class="nt">--cluster</span><span class="o">=</span>spinnaker-eks-nodes-NodeGroup-KLBYTZDP0F89 <span class="nt">--region</span><span class="o">=</span>us-west-2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Lastly, the <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-terminate.sh</code> script that is called by the generated <code class="highlighter-rouge">/etc/cron.d/chaosmonkey-schedule</code> cron job should issue the <code class="highlighter-rouge">chaosmonkey terminate</code> command and output the result to the log.  Paste the following into <code class="highlighter-rouge">/apps/chaosmonkey/chaosmonkey-terminate.sh</code>.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 /apps/chaosmonkey/chaosmonkey terminate <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /var/log/chaosmonkey-terminate.log 2&gt;&amp;1
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="next-steps">Next Steps</h4>

<p>You’re all set now!  If you followed along through the entire process you should have a functional Spinnaker deployment with Chaos Monkey enabled, which will perform a cron job once a day to terminate random instances based on your configuration!</p>

<p>However, Chaos Monkey is just the tip of the Chaos Engineering iceberg.  While using Chaos Monkey can be beneficial in certain circumstances, it’s worth remembering that you’re still limited to the (basic) tasks that the tool can accomplish.  While good Chaos Engineering practices encourage resilient and thorough testing of every aspect of your system and architecture, Chaos Monkey’s ability to randomly terminate instances can be helpful, but those abilities quickly reach their limit.</p>

<p>The rest of this guide will cover the other tools in <a href="/gremlin-chaos-monkey/simian-army">The Simian Army</a> family, along with an in-depth look at the <a href="/gremlin-chaos-monkey/alternatives">Chaos Monkey Alternatives</a>.  We built <a href="https://www.gremlin.com/product" target="_blank" rel="noopener noreferrer">Gremlin</a> to provide the framework to safely, securely, and easily simulate real outages with an ever-growing library of attacks.</p>


        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-09-12T00:00:00-07:00">September 12, 2018</time></p>
        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
    
    
    <li><a href="/gremlin-chaos-monkey/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2018 Gabe Wyatt</div>

      </footer>
    </div>

    
  <script src="/gremlin-chaos-monkey/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>








  </body>
</html>